#!/usr/bin/env node
import{serve as e}from"@hono/node-server";import{Hono as t}from"hono";import{prettyJSON as a}from"hono/pretty-json";import{HTTPException as o}from"hono/http-exception";import{SignatureV4 as r}from"@smithy/signature-v4";import{Sha256 as n}from"@aws-crypto/sha256-js";import s from"async-retry";import{env as i}from"hono/adapter";import{z as p}from"zod";const m="portkey",c={MODE:`x-${m}-mode`,RETRIES:`x-${m}-retry-count`,PROVIDER:`x-${m}-provider`,TRACE_ID:`x-${m}-trace-id`,CACHE:`x-${m}-cache`,FORWARD_HEADERS:`x-${m}-forward-headers`,CUSTOM_HOST:`x-${m}-custom-host`,REQUEST_TIMEOUT:`x-${m}-request-timeout`},l={RETRY_ATTEMPT_COUNT:`x-${m}-retry-attempt-count`,LAST_USED_OPTION_INDEX:`x-${m}-last-used-option-index`,LAST_USED_OPTION_PARAMS:`x-${m}-last-used-option-params`,CACHE_STATUS:`x-${m}-cache-status`,TRACE_ID:`x-${m}-trace-id`},d=[429,500,502,503,504],u=408,f=412,g="openai",h="cohere",_="azure-openai",y="anthropic",x="anyscale",k="palm",b="together-ai",v="google",w="vertex-ai",O="perplexity-ai",C="reka-ai",j="mistral-ai",q="deepinfra",T="stability-ai",S="nomic",$="ollama",N="ai21",E="bedrock",A="groq",R="segmind",D="jina",M="fireworks-ai",J="workers-ai",P="moonshot",I="openrouter",z="lingyi",B="zhipu",U="novita-ai",L="monsterapi",K="predibase",H=[y,x,_,h,v,w,j,g,k,O,C,b,q,T,S,$,N,E,A,R,D,M,J,P,I,z,B,U,L,K],G={APPLICATION_JSON:"application/json",MULTIPART_FORM_DATA:"multipart/form-data",EVENT_STREAM:"text/event-stream",AUDIO_MPEG:"audio/mpeg",APPLICATION_OCTET_STREAM:"application/octet-stream",GENERIC_AUDIO_PATTERN:"audio",PLAIN_TEXT:"text/plain",HTML:"text/html",GENERIC_IMAGE_PATTERN:"image/"},W=(e,t)=>({error:{message:`Invalid response received from ${t}: ${JSON.stringify(e)}`,type:null,param:null,code:null},provider:t}),X=({message:e,type:t,param:a,code:o},r)=>({error:{message:`${r} error: ${e}`,type:t??null,param:a??null,code:o??null},provider:r});function F(e,t){const a=e.indexOf(t);return-1===a?{before:e,after:""}:{before:e.substring(0,a),after:e.substring(a+1)}}const V=e=>{if("detail"in e)return X({message:e.detail,type:null,param:null,code:null},N)},Y={complete:{prompt:{param:"prompt",required:!0},n:{param:"numResults",default:1},max_tokens:{param:"maxTokens",default:16},minTokens:{param:"minTokens",default:0},temperature:{param:"temperature",default:.7,min:0,max:1},top_p:{param:"topP",default:1},top_k:{param:"topKReturn",default:0},stop:{param:"stopSequences"},presence_penalty:{param:"presencePenalty",transform:e=>({scale:e.presence_penalty})},frequency_penalty:{param:"frequencyPenalty",transform:e=>({scale:e.frequency_penalty})},countPenalty:{param:"countPenalty"},frequencyPenalty:{param:"frequencyPenalty"},presencePenalty:{param:"presencePenalty"}},chatComplete:{messages:[{param:"messages",required:!0,transform:e=>{let t=[];return"system"===e.messages?.[0]?.role?t=e.messages.slice(1):e.messages&&(t=e.messages),t.map((e=>({text:e.content,role:e.role})))}},{param:"system",required:!1,transform:e=>{if("system"===e.messages?.[0].role)return e.messages?.[0].content}}],n:{param:"numResults",default:1},max_tokens:{param:"maxTokens",default:16},minTokens:{param:"minTokens",default:0},temperature:{param:"temperature",default:.7,min:0,max:1},top_p:{param:"topP",default:1},top_k:{param:"topKReturn",default:0},stop:{param:"stopSequences"},presence_penalty:{param:"presencePenalty",transform:e=>({scale:e.presence_penalty})},frequency_penalty:{param:"frequencyPenalty",transform:e=>({scale:e.frequency_penalty})},countPenalty:{param:"countPenalty"},frequencyPenalty:{param:"frequencyPenalty"},presencePenalty:{param:"presencePenalty"}},embed:{input:{param:"texts",required:!0,transform:e=>Array.isArray(e.input)?e.input:[e.input]},type:{param:"type"}},api:{getBaseURL:()=>"https://api.ai21.com/studio/v1",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e,gatewayRequestBody:t})=>{const{model:a}=t;switch(e){case"complete":return`/${a}/complete`;case"chatComplete":return`/${a}/chat`;case"embed":return"/embed";default:return""}}},responseTransforms:{complete:(e,t)=>{if(200!==t){const t=V(e);if(t)return t}if("completions"in e){const t=e.prompt.tokens?.length||0,a=e.completions.map((e=>e.data?.tokens?.length||0)).reduce(((e,t)=>e+t),0);return{id:e.id,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:e.completions.map(((e,t)=>({text:e.data.text,index:t,logprobs:null,finish_reason:e.finishReason?.reason}))),usage:{prompt_tokens:t,completion_tokens:a,total_tokens:t+a}}}return W(e,N)},chatComplete:(e,t)=>{if(200!==t){const t=V(e);if(t)return t}return"outputs"in e?{id:e.id,object:"chat_completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:e.outputs.map(((e,t)=>({message:{role:"assistant",content:e.text},index:t,logprobs:null,finish_reason:e.finishReason?.reason})))}:W(e,N)},embed:(e,t)=>{if(200!==t){const t=V(e);if(t)return t}return"results"in e?{object:"list",data:e.results.map(((e,t)=>({object:"embedding",embedding:e.embedding,index:t}))),model:"",provider:N,usage:{prompt_tokens:-1,total_tokens:-1}}:W(e,N)}}},Q=e=>{if("error"in e)return X({message:e.error?.message,type:e.error?.type,param:null,code:null},y)},Z={complete:{model:{param:"model",default:"claude-instant-1",required:!0},prompt:{param:"prompt",transform:e=>`\n\nHuman: ${e.prompt}\n\nAssistant:`,required:!0},max_tokens:{param:"max_tokens_to_sample",required:!0},temperature:{param:"temperature",default:1,min:0,max:1},top_p:{param:"top_p",default:-1,min:-1},top_k:{param:"top_k",default:-1},stop:{param:"stop_sequences",transform:e=>null===e.stop?[]:e.stop},stream:{param:"stream",default:!1},user:{param:"metadata.user_id"}},chatComplete:{model:{param:"model",default:"claude-2.1",required:!0},messages:[{param:"messages",required:!0,transform:e=>{let t=[];return e.messages&&e.messages.forEach((e=>{if("system"!==e.role)if("assistant"===e.role)t.push((e=>{let t=[];const a=e.tool_calls&&e.tool_calls.length;return e.content&&"string"==typeof e.content?t.push({type:"text",text:e.content}):e.content&&"object"==typeof e.content&&e.content.length&&e.content[0].text&&t.push({type:"text",text:e.content[0].text}),a&&e.tool_calls.forEach((e=>{t.push({type:"tool_use",name:e.function.name,id:e.id,input:JSON.parse(e.function.arguments)})})),{role:e.role,content:t}})(e));else if(e.content&&"object"==typeof e.content&&e.content.length){const a={role:e.role,content:[]};e.content.forEach((e=>{if("text"===e.type)a.content.push({type:e.type,text:e.text});else if("image_url"===e.type&&e.image_url&&e.image_url.url){const t=e.image_url.url.split(";");if(2===t.length){const e=t[1].split(",")[1],o=t[0].split(":");if(2===o.length&&e){const t=o[1];a.content.push({type:"image",source:{type:"base64",media_type:t,data:e}})}}}})),t.push(a)}else"tool"===e.role?t.push((e=>({role:"user",content:[{type:"tool_result",tool_use_id:e.tool_call_id,content:e.content}]}))(e)):t.push({role:e.role,content:e.content})})),t}},{param:"system",required:!1,transform:e=>{let t="";return e.messages&&e.messages.forEach((e=>{"system"===e.role&&e.content&&"object"==typeof e.content&&e.content[0].text?t=e.content[0].text:"system"===e.role&&"string"==typeof e.content&&(t=e.content)})),t}}],tools:{param:"tools",required:!1,transform:e=>{let t=[];return e.tools&&e.tools.forEach((e=>{e.function&&t.push({name:e.function.name,description:e.function?.description||"",input_schema:{type:e.function.parameters?.type||"object",properties:e.function.parameters?.properties||{},required:e.function.parameters?.required||[]}})})),t}},tool_choice:{param:"tool_choice",required:!1,transform:e=>{if(e.tool_choice)if("string"==typeof e.tool_choice){if("required"===e.tool_choice)return{type:"any"};if("auto"===e.tool_choice)return{type:"auto"}}else if("object"==typeof e.tool_choice)return{type:"tool",name:e.tool_choice.function.name};return null}},max_tokens:{param:"max_tokens",required:!0},temperature:{param:"temperature",default:1,min:0,max:1},top_p:{param:"top_p",default:-1,min:-1},top_k:{param:"top_k",default:-1},stop:{param:"stop_sequences"},stream:{param:"stream",default:!1},user:{param:"metadata.user_id"}},api:{getBaseURL:()=>"https://api.anthropic.com/v1",headers:({providerOptions:e,fn:t})=>{const a={"X-API-Key":`${e.apiKey}`,"anthropic-version":"2023-06-01"};return"chatComplete"===t&&(a["anthropic-beta"]="messages-2023-12-15"),a},getEndpoint:({fn:e})=>{switch(e){case"complete":return"/complete";case"chatComplete":return"/messages";default:return""}}},responseTransforms:{"stream-complete":e=>{let t=e.trim();if(t.startsWith("event: ping"))return;if(t=t.replace(/^event: completion[\r\n]*/,""),t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return t;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.log_id,object:"text_completion",created:Math.floor(Date.now()/1e3),model:a.model,provider:"anthropic",choices:[{text:a.completion,index:0,logprobs:null,finish_reason:a.stop_reason}]})}\n\n`},complete:(e,t)=>{if(200!==t){const t=Q(e);if(t)return t}return"completion"in e?{id:e.log_id,object:"text_completion",created:Math.floor(Date.now()/1e3),model:e.model,provider:y,choices:[{text:e.completion,index:0,logprobs:null,finish_reason:e.stop_reason}]}:W(e,y)},chatComplete:(e,t)=>{if(200!==t){const t=Q(e);if(t)return t}if("content"in e){const{input_tokens:t=0,output_tokens:a=0}=e?.usage;let o="";e.content.length&&"text"===e.content[0].type&&(o=e.content[0].text);let r=[];return e.content.forEach((e=>{"tool_use"===e.type&&r.push({id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.input)}})})),{id:e.id,object:"chat_completion",created:Math.floor(Date.now()/1e3),model:e.model,provider:y,choices:[{message:{role:"assistant",content:o,tool_calls:r.length?r:void 0},index:0,logprobs:null,finish_reason:e.stop_reason}],usage:{prompt_tokens:t,completion_tokens:a,total_tokens:t+a}}}return W(e,y)},"stream-chatComplete":(e,t,a)=>{let o=e.trim();if(o.startsWith("event: ping")||o.startsWith("event: content_block_stop"))return;if(o.startsWith("event: message_stop"))return"data: [DONE]\n\n";o=o.replace(/^event: content_block_delta[\r\n]*/,""),o=o.replace(/^event: content_block_start[\r\n]*/,""),o=o.replace(/^event: message_delta[\r\n]*/,""),o=o.replace(/^event: message_start[\r\n]*/,""),o=o.replace(/^data: /,""),o=o.trim();const r=JSON.parse(o);if("content_block_start"===r.type&&"text"===r.content_block?.type)return void(a.containsChainOfThoughtMessage=!0);if("message_start"===r.type&&r.message?.usage)return`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:y,choices:[{delta:{content:""},index:0,logprobs:null,finish_reason:null}],usage:{prompt_tokens:r.message?.usage?.input_tokens}})}\n\n`;if("message_delta"===r.type&&r.usage)return`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:y,choices:[{index:0,delta:{},finish_reason:r.delta?.stop_reason}],usage:{completion_tokens:r.usage?.output_tokens}})}\n\n`;const n=[],s="content_block_start"===r.type&&!!r.content_block?.id,i="content_block_delta"===r.type&&!!r.delta.partial_json,p=a.containsChainOfThoughtMessage?r.index-1:r.index;return s&&r.content_block?n.push({index:p,id:r.content_block.id,type:"function",function:{name:r.content_block.name,arguments:""}}):i&&n.push({index:p,function:{arguments:r.delta.partial_json}}),`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:y,choices:[{delta:{content:r.delta?.text,tool_calls:n.length?n:void 0},index:0,logprobs:null,finish_reason:r.delta?.stop_reason??null}]})}\n\n`}}},ee=e=>{if("detail"in e&&e.detail.length){let t,a,o=null,r=null;return Array.isArray(e.detail)?([t]=e.detail,o=t?.loc?.join(".")??"",a=t.msg,r=t.type):a=e.detail,X({message:`${o?`${o}: `:""}${a}`,type:r,param:null,code:null},x)}if("error"in e)return X({message:e.error?.message,type:e.error?.type,param:null,code:null},x)},te={complete:{model:{param:"model",required:!0,default:"Meta-Llama/Llama-Guard-7b"},prompt:{param:"prompt",default:""},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},n:{param:"n",default:1},stream:{param:"stream",default:!1},logprobs:{param:"logprobs",max:5},echo:{param:"echo",default:!1},stop:{param:"stop"},presence_penalty:{param:"presence_penalty",min:-2,max:2},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},best_of:{param:"best_of"},logit_bias:{param:"logit_bias"},user:{param:"user"}},chatComplete:{model:{param:"model",required:!0,default:"meta-llama/Llama-2-7b-chat-hf"},messages:{param:"messages",default:""},functions:{param:"functions"},function_call:{param:"function_call"},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},n:{param:"n",default:1},stream:{param:"stream",default:!1},stop:{param:"stop"},presence_penalty:{param:"presence_penalty",min:-2,max:2},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},logit_bias:{param:"logit_bias"},user:{param:"user"},tools:{param:"tools"},tool_choice:{param:"tool_choice"},response_format:{param:"response_format"},logprobs:{param:"logprobs",default:!1},top_logprobs:{param:"top_logprobs"}},embed:{model:{param:"model",required:!0,default:"thenlper/gte-large"},input:{param:"input",default:""},user:{param:"user"}},api:{getBaseURL:()=>"https://api.endpoints.anyscale.com/v1",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>{switch(e){case"chatComplete":return"/chat/completions";case"complete":return"/completions";case"embed":return"/embeddings";default:return""}}},responseTransforms:{"stream-complete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:x,choices:a.choices})}\n\n`},complete:(e,t)=>{if(200!==t){const t=ee(e);if(t)return t}return"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:x,choices:e.choices,usage:e.usage}:W(e,x)},chatComplete:(e,t)=>{if(200!==t){const t=ee(e);if(t)return t}return"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:x,choices:e.choices,usage:e.usage}:W(e,x)},"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:x,choices:a.choices})}\n\n`},embed:(e,t)=>{if(200!==t){const t=ee(e);if(t)return t}return"data"in e?{object:e.object,data:e.data,model:e.model,usage:e.usage}:W(e,x)}}},ae=(e,t)=>X({...e.error},t),oe=(e,t)=>{const a=[],{id:o,model:r,system_fingerprint:n,choices:s}=e,{prompt_tokens:i,completion_tokens:p}=e.usage||{};let m;i&&p&&(m=i+p);const c={id:o,object:"chat.completion.chunk",created:Date.now(),model:r||"",system_fingerprint:n||null,provider:t,usage:{...p&&{completion_tokens:p},...i&&{prompt_tokens:i},...m&&{total_tokens:m}}};for(const[e,t]of s.entries()){if(t.message&&t.message.tool_calls&&t.message.tool_calls.length)for(const[o,r]of t.message.tool_calls.entries()){const t={index:o,id:r.id,type:"function",function:{name:r.function.name,arguments:""}},n={index:o,function:{arguments:r.function.arguments}};a.push(`data: ${JSON.stringify({...c,choices:[{index:e,delta:{role:"assistant",content:null,tool_calls:[t]}}]})}\n\n`),a.push(`data: ${JSON.stringify({...c,choices:[{index:e,delta:{role:"assistant",tool_calls:[n]}}]})}\n\n`)}if(t.message&&t.message.content&&"string"==typeof t.message.content){const o=[];for(let e=0;e<t.message.content.length;e+=4)o.push(t.message.content.slice(e,e+4));o.forEach((t=>{a.push(`data: ${JSON.stringify({...c,choices:[{index:e,delta:{role:"assistant",content:t}}]})}\n\n`)}))}a.push(`data: ${JSON.stringify({...c,choices:[{index:e,delta:{},finish_reason:t.finish_reason}]})}\n\n`)}return a.push("data: [DONE]\n\n"),a},re={complete:{model:{param:"model"},prompt:{param:"prompt",default:""},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},n:{param:"n",default:1},stream:{param:"stream",default:!1},logprobs:{param:"logprobs",max:5},echo:{param:"echo",default:!1},stop:{param:"stop"},presence_penalty:{param:"presence_penalty",min:-2,max:2},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},best_of:{param:"best_of"},logit_bias:{param:"logit_bias"},user:{param:"user"}},embed:{model:{param:"model"},input:{param:"input",required:!0},user:{param:"user"}},api:{getBaseURL:({providerOptions:e})=>{const{resourceName:t,deploymentId:a}=e;return`https://${t}.openai.azure.com/openai/deployments/${a}`},headers:({providerOptions:e})=>{const{apiKey:t}=e;return{"api-key":`${t}`}},getEndpoint:({providerOptions:e,fn:t})=>{const{apiVersion:a,urlToFetch:o}=e;let r=t;switch("proxy"===t&&o&&(o?.indexOf("/chat/completions")>-1?r="chatComplete":o?.indexOf("/completions")>-1?r="complete":o?.indexOf("/embeddings")>-1?r="embed":o?.indexOf("/images/generations")>-1&&(r="imageGenerate")),r){case"complete":return`/completions?api-version=${a}`;case"chatComplete":return`/chat/completions?api-version=${a}`;case"embed":return`/embeddings?api-version=${a}`;case"imageGenerate":return`/images/generations?api-version=${a}`;default:return""}}},imageGenerate:{prompt:{param:"prompt",required:!0},model:{param:"model",required:!0,default:"dall-e-3"},n:{param:"n",min:1,max:10},quality:{param:"quality"},response_format:{param:"response_format"},size:{param:"size"},style:{param:"style"},user:{param:"user"}},chatComplete:{model:{param:"model"},messages:{param:"messages",default:""},functions:{param:"functions"},function_call:{param:"function_call"},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},n:{param:"n",default:1},stream:{param:"stream",default:!1},stop:{param:"stop"},presence_penalty:{param:"presence_penalty",min:-2,max:2},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},logit_bias:{param:"logit_bias"},user:{param:"user"},tools:{param:"tools"},tool_choice:{param:"tool_choice"},response_format:{param:"response_format"}},responseTransforms:{complete:(e,t)=>200!==t&&"error"in e?ae(e,_):e,chatComplete:(e,t)=>200!==t&&"error"in e?ae(e,_):e,embed:(e,t)=>200!==t&&"error"in e?ae(e,_):e,imageGenerate:(e,t)=>200!==t&&"error"in e?ae(e,_):e}},ne={getBaseURL:({providerOptions:e})=>`https://bedrock-runtime.${e.awsRegion||"us-east-1"}.amazonaws.com`,headers:async({providerOptions:e,transformedRequestBody:t,transformedRequestUrl:a})=>(async(e,t,a,o,s,i,p,m,c)=>{const l=new r({service:s,region:i||"us-east-1",credentials:{accessKeyId:p,secretAccessKey:m,...c&&{sessionToken:c}},sha256:n}),d=new URL(a),u=d.hostname;t.host=u;const f={method:o,path:d.pathname,protocol:"https",hostname:d.hostname,headers:t,body:JSON.stringify(e)};return(await l.sign(f)).headers})(t,{"content-type":"application/json"},a,"POST","bedrock",e.awsRegion||"",e.awsAccessKeyId||"",e.awsSecretAccessKey||"",e.awsSessionToken||""),getEndpoint:({fn:e,gatewayRequestBody:t})=>{const{model:a,stream:o}=t;let r=e;o&&(r=`stream-${e}`);const n=`/model/${a}/invoke`,s=`/model/${a}/invoke-with-response-stream`;switch(r){case"chatComplete":case"complete":case"embed":case"imageGenerate":return n;case"stream-chatComplete":case"stream-complete":return s;default:return""}}},se={messages:[{param:"messages",required:!0,transform:e=>{let t=[];return e.messages&&e.messages.forEach((e=>{if("system"!==e.role)if("assistant"===e.role)t.push((e=>{let t=[];const a=e.tool_calls&&e.tool_calls.length;return e.content&&"string"==typeof e.content?t.push({type:"text",text:e.content}):e.content&&"object"==typeof e.content&&e.content.length&&e.content[0].text&&t.push({type:"text",text:e.content[0].text}),a&&e.tool_calls.forEach((e=>{t.push({type:"tool_use",name:e.function.name,id:e.id,input:JSON.parse(e.function.arguments)})})),{role:e.role,content:t}})(e));else if(e.content&&"object"==typeof e.content&&e.content.length){const a={role:e.role,content:[]};e.content.forEach((e=>{if("text"===e.type)a.content.push({type:e.type,text:e.text});else if("image_url"===e.type&&e.image_url&&e.image_url.url){const t=e.image_url.url.split(";");if(2===t.length){const e=t[1].split(",")[1],o=t[0].split(":");if(2===o.length&&e){const t=o[1];a.content.push({type:"image",source:{type:"base64",media_type:t,data:e}})}}}})),t.push(a)}else"tool"===e.role?t.push((e=>({role:"user",content:[{type:"tool_result",tool_use_id:e.tool_call_id,content:e.content}]}))(e)):t.push({role:e.role,content:e.content})})),t}},{param:"system",required:!1,transform:e=>{let t="";return e.messages&&e.messages.forEach((e=>{"system"===e.role&&e.content&&"object"==typeof e.content&&e.content[0].text?t=e.content[0].text:"system"===e.role&&"string"==typeof e.content&&(t=e.content)})),t}}],tools:{param:"tools",required:!1,transform:e=>{let t=[];return e.tools&&e.tools.forEach((e=>{e.function&&t.push({name:e.function.name,description:e.function?.description||"",input_schema:{type:e.function.parameters?.type||"object",properties:e.function.parameters?.properties||{},required:e.function.parameters?.required||[]}})})),t}},tool_choice:{param:"tool_choice",required:!1,transform:e=>{if(e.tool_choice)if("string"==typeof e.tool_choice){if("required"===e.tool_choice)return{type:"any"};if("auto"===e.tool_choice)return{type:"auto"}}else if("object"==typeof e.tool_choice)return{type:"tool",name:e.tool_choice.function.name};return null}},max_tokens:{param:"max_tokens",required:!0},temperature:{param:"temperature",default:1,min:0,max:1},top_p:{param:"top_p",default:-1,min:-1},top_k:{param:"top_k",default:-1},stop:{param:"stop_sequences",transform:e=>null===e.stop?[]:e.stop},user:{param:"metadata.user_id"},anthropic_version:{param:"anthropic_version",required:!0,default:"bedrock-2023-05-31"}},ie={messages:{param:"prompt",required:!0,transform:e=>{let t="";if(e.messages){let a=e.messages;a.forEach(((e,o)=>{0===o&&"system"===e.role?t+=`system: ${a}\n`:"user"==e.role?t+=`user: ${e.content}\n`:"assistant"==e.role?t+=`assistant: ${e.content}\n`:t+=`${e.role}: ${e.content}\n`})),t+="Assistant:"}return t}},max_tokens:{param:"max_tokens",default:20,min:1},temperature:{param:"temperature",default:.75,min:0,max:5},top_p:{param:"p",default:.75,min:0,max:1},top_k:{param:"k",default:0,max:500},frequency_penalty:{param:"frequency_penalty",default:0,min:0,max:1},presence_penalty:{param:"presence_penalty",default:0,min:0,max:1},logit_bias:{param:"logit_bias"},n:{param:"num_generations",default:1,min:1,max:5},stop:{param:"end_sequences"},stream:{param:"stream"}},pe={messages:{param:"prompt",required:!0,transform:e=>{let t="";if(e.messages){let a=e.messages;a.forEach(((e,o)=>{0===o&&"system"===e.role?t+=`system: ${a}\n`:"user"==e.role?t+=`user: ${e.content}\n`:"assistant"==e.role?t+=`assistant: ${e.content}\n`:t+=`${e.role}: ${e.content}\n`})),t+="Assistant:"}return t}},max_tokens:{param:"max_gen_len",default:512,min:1,max:2048},temperature:{param:"temperature",default:.5,min:0,max:1},top_p:{param:"top_p",default:.9,min:0,max:1}},me={messages:{param:"prompt",required:!0,transform:e=>{let t="";if(e.messages){let a=e.messages;a.forEach(((e,o)=>{0===o&&"system"===e.role?t+=`system: ${a}\n`:"user"==e.role?t+=`user: ${e.content}\n`:"assistant"==e.role?t+=`assistant: ${e.content}\n`:t+=`${e.role}: ${e.content}\n`})),t+="Assistant:"}return t}},max_tokens:{param:"max_tokens",default:20,min:1},temperature:{param:"temperature",default:.75,min:0,max:5},top_p:{param:"top_p",default:.75,min:0,max:1},top_k:{param:"top_k",default:0,max:200},stop:{param:"stop"}},ce=e=>{const t={};return e.temperature&&(t.temperature=e.temperature),e.top_p&&(t.topP=e.top_p),e.max_tokens&&(t.maxTokenCount=e.max_tokens),e.stop&&(t.stopSequences=e.stop),t},le={messages:{param:"inputText",required:!0,transform:e=>{let t="";if(e.messages){let a=e.messages;a.forEach(((e,o)=>{0===o&&"system"===e.role?t+=`system: ${a}\n`:"user"==e.role?t+=`user: ${e.content}\n`:"assistant"==e.role?t+=`assistant: ${e.content}\n`:t+=`${e.role}: ${e.content}\n`})),t+="Assistant:"}return t}},temperature:{param:"textGenerationConfig",transform:e=>ce(e)},max_tokens:{param:"textGenerationConfig",transform:e=>ce(e)},top_p:{param:"textGenerationConfig",transform:e=>ce(e)}},de={messages:{param:"prompt",required:!0,transform:e=>{let t="";if(e.messages){let a=e.messages;a.forEach(((e,o)=>{0===o&&"system"===e.role?t+=`system: ${a}\n`:"user"==e.role?t+=`user: ${e.content}\n`:"assistant"==e.role?t+=`assistant: ${e.content}\n`:t+=`${e.role}: ${e.content}\n`})),t+="Assistant:"}return t}},max_tokens:{param:"maxTokens",default:200},temperature:{param:"temperature",default:.7,min:0,max:1},top_p:{param:"topP",default:1},stop:{param:"stopSequences"},presence_penalty:{param:"presencePenalty",transform:e=>({scale:e.presence_penalty})},frequency_penalty:{param:"frequencyPenalty",transform:e=>({scale:e.frequency_penalty})},countPenalty:{param:"countPenalty"},frequencyPenalty:{param:"frequencyPenalty"},presencePenalty:{param:"presencePenalty"}},ue=e=>{if("message"in e)return X({message:e.message,type:null,param:null,code:null},E)},fe=(e,t)=>{if(200!==t){const t=ue(e);if(t)return t}return"generation"in e?{id:Date.now().toString(),object:"chat.completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{index:0,message:{role:"assistant",content:e.generation},finish_reason:e.stop_reason}],usage:{prompt_tokens:e.prompt_token_count,completion_tokens:e.generation_token_count,total_tokens:e.prompt_token_count+e.generation_token_count}}:W(e,E)},ge=(e,t)=>{let a=e.trim();a=a.trim();const o=JSON.parse(a);return o.stop_reason?[`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{delta:{},index:0,logprobs:null,finish_reason:o.stop_reason}],usage:{prompt_tokens:o["amazon-bedrock-invocationMetrics"].inputTokenCount,completion_tokens:o["amazon-bedrock-invocationMetrics"].outputTokenCount,total_tokens:o["amazon-bedrock-invocationMetrics"].inputTokenCount+o["amazon-bedrock-invocationMetrics"].outputTokenCount}})}\n\n`,"data: [DONE]\n\n"]:`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{index:0,delta:{role:"assistant",content:o.generation},finish_reason:null}]})}\n\n`},he=(e,t)=>{if(200!==t){const t=ue(e);if(t)return t}if("results"in e){const t=e.results.map((e=>e.tokenCount)).reduce(((e,t)=>e+t),0);return{id:Date.now().toString(),object:"chat.completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:e.results.map(((e,t)=>({index:t,message:{role:"assistant",content:e.outputText},finish_reason:e.completionReason}))),usage:{prompt_tokens:e.inputTextTokenCount,completion_tokens:t,total_tokens:e.inputTextTokenCount+t}}}return W(e,E)},_e=(e,t)=>{let a=e.trim();a=a.trim();const o=JSON.parse(a);return[`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{index:0,delta:{role:"assistant",content:o.outputText},finish_reason:null}]})}\n\n`,`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{index:0,delta:{},finish_reason:o.completionReason}],usage:{prompt_tokens:o["amazon-bedrock-invocationMetrics"].inputTokenCount,completion_tokens:o["amazon-bedrock-invocationMetrics"].outputTokenCount,total_tokens:o["amazon-bedrock-invocationMetrics"].inputTokenCount+o["amazon-bedrock-invocationMetrics"].outputTokenCount}})}\n\n`,"data: [DONE]\n\n"]},ye=(e,t,a)=>{if(200!==t){const t=ue(e);if(t)return t}if("completions"in e){const t=Number(a.get("X-Amzn-Bedrock-Input-Token-Count"))||0,o=Number(a.get("X-Amzn-Bedrock-Output-Token-Count"))||0;return{id:e.id.toString(),object:"chat.completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:e.completions.map(((e,t)=>({index:t,message:{role:"assistant",content:e.data.text},finish_reason:e.finishReason?.reason}))),usage:{prompt_tokens:t,completion_tokens:o,total_tokens:t+o}}}return W(e,E)},xe=(e,t,a)=>{if(200!==t){const t=ue(e);if(t)return t}if("content"in e){const t=Number(a.get("X-Amzn-Bedrock-Input-Token-Count"))||0,o=Number(a.get("X-Amzn-Bedrock-Output-Token-Count"))||0;let r="";e.content.length&&"text"===e.content[0].type&&(r=e.content[0].text);let n=[];return e.content.forEach((e=>{"tool_use"===e.type&&n.push({id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.input)}})})),{id:e.id,object:"chat.completion",created:Math.floor(Date.now()/1e3),model:e.model,provider:E,choices:[{message:{role:"assistant",content:r,tool_calls:n.length?n:void 0},index:0,logprobs:null,finish_reason:e.stop_reason}],usage:{prompt_tokens:t,completion_tokens:o,total_tokens:t+o}}}return W(e,E)},ke=(e,t,a)=>{let o=e.trim();const r=JSON.parse(o);if("ping"===r.type||"message_start"===r.type||"content_block_stop"===r.type)return[];if("content_block_start"===r.type&&"text"===r.content_block?.type)return void(a.containsChainOfThoughtMessage=!0);if("message_stop"===r.type)return[`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{index:0,delta:{},finish_reason:r.delta?.stop_reason}],usage:{prompt_tokens:r["amazon-bedrock-invocationMetrics"].inputTokenCount,completion_tokens:r["amazon-bedrock-invocationMetrics"].outputTokenCount,total_tokens:r["amazon-bedrock-invocationMetrics"].inputTokenCount+r["amazon-bedrock-invocationMetrics"].outputTokenCount}})}\n\n`,"data: [DONE]\n\n"];if(r.delta?.stop_reason)return[`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{delta:{content:r.delta?.text},index:0,logprobs:null,finish_reason:r.delta?.stop_reason??null}]})}\n\n`];const n=[],s="content_block_start"===r.type&&!!r.content_block?.id,i="content_block_delta"===r.type&&!!r.delta.partial_json,p=a.containsChainOfThoughtMessage?r.index-1:r.index;return s&&r.content_block?n.push({index:p,id:r.content_block.id,type:"function",function:{name:r.content_block.name,arguments:""}}):i&&n.push({index:p,function:{arguments:r.delta.partial_json}}),`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{delta:{content:r.delta?.text,tool_calls:n.length?n:void 0},index:0,logprobs:null,finish_reason:r.delta?.stop_reason??null}]})}\n\n`},be=(e,t,a)=>{if(200!==t){const t=ue(e);if(t)return t}if("generations"in e){const t=Number(a.get("X-Amzn-Bedrock-Input-Token-Count"))||0,o=Number(a.get("X-Amzn-Bedrock-Output-Token-Count"))||0;return{id:Date.now().toString(),object:"chat.completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:e.generations.map(((e,t)=>({index:t,message:{role:"assistant",content:e.text},finish_reason:e.finish_reason}))),usage:{prompt_tokens:t,completion_tokens:o,total_tokens:t+o}}}return W(e,E)},ve=(e,t)=>{let a=e.trim();a=a.replace(/^data: /,""),a=a.trim();const o=JSON.parse(a);return o.is_finished?[`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{index:o.index??0,delta:{},finish_reason:o.finish_reason}],usage:{prompt_tokens:o["amazon-bedrock-invocationMetrics"].inputTokenCount,completion_tokens:o["amazon-bedrock-invocationMetrics"].outputTokenCount,total_tokens:o["amazon-bedrock-invocationMetrics"].inputTokenCount+o["amazon-bedrock-invocationMetrics"].outputTokenCount}})}\n\n`,"data: [DONE]\n\n"]:`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{index:o.index??0,delta:{role:"assistant",content:o.text},finish_reason:null}]})}\n\n`},we=(e,t,a)=>{if(200!==t){const t=ue(e);if(t)return t}if("outputs"in e){const t=Number(a.get("X-Amzn-Bedrock-Input-Token-Count"))||0,o=Number(a.get("X-Amzn-Bedrock-Output-Token-Count"))||0;return{id:Date.now().toString(),object:"chat.completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{index:0,message:{role:"assistant",content:e.outputs[0].text},finish_reason:e.outputs[0].stop_reason}],usage:{prompt_tokens:t,completion_tokens:o,total_tokens:t+o}}}return W(e,E)},Oe=(e,t)=>{let a=e.trim();a=a.replace(/^data: /,""),a=a.trim();const o=JSON.parse(a);return o.outputs[0].stop_reason?[`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{index:0,delta:{},finish_reason:o.outputs[0].stop_reason}],usage:{prompt_tokens:o["amazon-bedrock-invocationMetrics"].inputTokenCount,completion_tokens:o["amazon-bedrock-invocationMetrics"].outputTokenCount,total_tokens:o["amazon-bedrock-invocationMetrics"].inputTokenCount+o["amazon-bedrock-invocationMetrics"].outputTokenCount}})}\n\n`,"data: [DONE]\n\n"]:`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{index:0,delta:{role:"assistant",content:o.outputs[0].text},finish_reason:null}]})}\n\n`},Ce={prompt:{param:"prompt",transform:e=>`\n\nHuman: ${e.prompt}\n\nAssistant:`,required:!0},max_tokens:{param:"max_tokens_to_sample",required:!0},temperature:{param:"temperature",default:1,min:0,max:1},top_p:{param:"top_p",default:-1,min:-1},top_k:{param:"top_k",default:-1},stop:{param:"stop_sequences",transform:e=>null===e.stop?[]:e.stop},user:{param:"metadata.user_id"}},je={prompt:{param:"prompt",required:!0},max_tokens:{param:"max_tokens",default:20,min:1},temperature:{param:"temperature",default:.75,min:0,max:5},top_p:{param:"p",default:.75,min:0,max:1},top_k:{param:"k",default:0,max:500},frequency_penalty:{param:"frequency_penalty",default:0,min:0,max:1},presence_penalty:{param:"presence_penalty",default:0,min:0,max:1},logit_bias:{param:"logit_bias"},n:{param:"num_generations",default:1,min:1,max:5},stop:{param:"end_sequences"},stream:{param:"stream"}},qe={prompt:{param:"prompt",required:!0},max_tokens:{param:"max_gen_len",default:512,min:1,max:2048},temperature:{param:"temperature",default:.5,min:0,max:1},top_p:{param:"top_p",default:.9,min:0,max:1}},Te={prompt:{param:"prompt",required:!0},max_tokens:{param:"max_tokens",default:20,min:1},temperature:{param:"temperature",default:.75,min:0,max:5},top_p:{param:"top_p",default:.75,min:0,max:1},top_k:{param:"top_k",default:0},stop:{param:"stop"}},Se=e=>{const t={};return e.temperature&&(t.temperature=e.temperature),e.top_p&&(t.topP=e.top_p),e.max_tokens&&(t.maxTokenCount=e.max_tokens),e.stop&&(t.stopSequences=e.stop),t},$e={prompt:{param:"inputText",required:!0},temperature:{param:"textGenerationConfig",transform:e=>Se(e)},max_tokens:{param:"textGenerationConfig",transform:e=>Se(e)},top_p:{param:"textGenerationConfig",transform:e=>Se(e)}},Ne={prompt:{param:"prompt",required:!0},max_tokens:{param:"maxTokens",default:200},temperature:{param:"temperature",default:.7,min:0,max:1},top_p:{param:"topP",default:1},stop:{param:"stopSequences"},presence_penalty:{param:"presencePenalty",transform:e=>({scale:e.presence_penalty})},frequency_penalty:{param:"frequencyPenalty",transform:e=>({scale:e.frequency_penalty})},countPenalty:{param:"countPenalty"},frequencyPenalty:{param:"frequencyPenalty"},presencePenalty:{param:"presencePenalty"}},Ee=(e,t)=>{if(200!==t){const t=ue(e);if(t)return t}return"generation"in e?{id:Date.now().toString(),object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{text:e.generation,index:0,logprobs:null,finish_reason:e.stop_reason}],usage:{prompt_tokens:e.prompt_token_count,completion_tokens:e.generation_token_count,total_tokens:e.prompt_token_count+e.generation_token_count}}:W(e,E)},Ae=(e,t)=>{let a=e.trim();a=a.trim();const o=JSON.parse(a);return o.stop_reason?[`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{text:"",index:0,logprobs:null,finish_reason:o.stop_reason}],usage:{prompt_tokens:o["amazon-bedrock-invocationMetrics"].inputTokenCount,completion_tokens:o["amazon-bedrock-invocationMetrics"].outputTokenCount,total_tokens:o["amazon-bedrock-invocationMetrics"].inputTokenCount+o["amazon-bedrock-invocationMetrics"].outputTokenCount}})}\n\n`,"data: [DONE]\n\n"]:`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{text:o.generation,index:0,logprobs:null,finish_reason:null}]})}\n\n`},Re=(e,t)=>{if(200!==t){const t=ue(e);if(t)return t}if("results"in e){const t=e.results.map((e=>e.tokenCount)).reduce(((e,t)=>e+t),0);return{id:Date.now().toString(),object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:e.results.map(((e,t)=>({text:e.outputText,index:t,logprobs:null,finish_reason:e.completionReason}))),usage:{prompt_tokens:e.inputTextTokenCount,completion_tokens:t,total_tokens:e.inputTextTokenCount+t}}}return W(e,E)},De=(e,t)=>{let a=e.trim();a=a.trim();const o=JSON.parse(a);return[`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{text:o.outputText,index:0,logprobs:null,finish_reason:null}]})}\n\n`,`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{text:"",index:0,logprobs:null,finish_reason:o.completionReason}],usage:{prompt_tokens:o["amazon-bedrock-invocationMetrics"].inputTokenCount,completion_tokens:o["amazon-bedrock-invocationMetrics"].outputTokenCount,total_tokens:o["amazon-bedrock-invocationMetrics"].inputTokenCount+o["amazon-bedrock-invocationMetrics"].outputTokenCount}})}\n\n`,"data: [DONE]\n\n"]},Me=(e,t,a)=>{if(200!==t){const t=ue(e);if(t)return t}if("completions"in e){const t=Number(a.get("X-Amzn-Bedrock-Input-Token-Count"))||0,o=Number(a.get("X-Amzn-Bedrock-Output-Token-Count"))||0;return{id:e.id.toString(),object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:e.completions.map(((e,t)=>({text:e.data.text,index:t,logprobs:null,finish_reason:e.finishReason?.reason}))),usage:{prompt_tokens:t,completion_tokens:o,total_tokens:t+o}}}return W(e,E)},Je=(e,t,a)=>{if(200!==t){const t=ue(e);if(t)return t}if("completion"in e){const t=Number(a.get("X-Amzn-Bedrock-Input-Token-Count"))||0,o=Number(a.get("X-Amzn-Bedrock-Output-Token-Count"))||0;return{id:Date.now().toString(),object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{text:e.completion,index:0,logprobs:null,finish_reason:e.stop_reason}],usage:{prompt_tokens:t,completion_tokens:o,total_tokens:t+o}}}return W(e,E)},Pe=(e,t)=>{let a=e.trim();const o=JSON.parse(a);return o.stop_reason?[`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{text:o.completion,index:0,logprobs:null,finish_reason:null}]})}\n\n`,`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{text:"",index:0,logprobs:null,finish_reason:o.stop_reason}],usage:{prompt_tokens:o["amazon-bedrock-invocationMetrics"].inputTokenCount,completion_tokens:o["amazon-bedrock-invocationMetrics"].outputTokenCount,total_tokens:o["amazon-bedrock-invocationMetrics"].inputTokenCount+o["amazon-bedrock-invocationMetrics"].outputTokenCount}})}\n\n`,"data: [DONE]\n\n"]:`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{text:o.completion,index:0,logprobs:null,finish_reason:null}]})}\n\n`},Ie=(e,t,a)=>{if(200!==t){const t=ue(e);if(t)return t}if("generations"in e){const t=Number(a.get("X-Amzn-Bedrock-Input-Token-Count"))||0,o=Number(a.get("X-Amzn-Bedrock-Output-Token-Count"))||0;return{id:e.id,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:e.generations.map(((e,t)=>({text:e.text,index:t,logprobs:null,finish_reason:e.finish_reason}))),usage:{prompt_tokens:t,completion_tokens:o,total_tokens:t+o}}}return W(e,E)},ze=(e,t)=>{let a=e.trim();a=a.replace(/^data: /,""),a=a.trim();const o=JSON.parse(a);return o.is_finished?[`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{text:"",index:0,logprobs:null,finish_reason:o.finish_reason}],usage:{prompt_tokens:o["amazon-bedrock-invocationMetrics"].inputTokenCount,completion_tokens:o["amazon-bedrock-invocationMetrics"].outputTokenCount,total_tokens:o["amazon-bedrock-invocationMetrics"].inputTokenCount+o["amazon-bedrock-invocationMetrics"].outputTokenCount}})}\n\n`,"data: [DONE]\n\n"]:`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{text:o.text,index:o.index??0,logprobs:null,finish_reason:null}]})}\n\n`},Be=(e,t)=>{let a=e.trim();a=a.trim();const o=JSON.parse(a);return o.outputs[0].stop_reason?[`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{text:o.outputs[0].text,index:0,logprobs:null,finish_reason:o.outputs[0].stop_reason}],usage:{prompt_tokens:o["amazon-bedrock-invocationMetrics"].inputTokenCount,completion_tokens:o["amazon-bedrock-invocationMetrics"].outputTokenCount,total_tokens:o["amazon-bedrock-invocationMetrics"].inputTokenCount+o["amazon-bedrock-invocationMetrics"].outputTokenCount}})}\n\n`,"data: [DONE]\n\n"]:`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{text:o.outputs[0].text,index:0,logprobs:null,finish_reason:null}]})}\n\n`},Ue=(e,t,a)=>{if(200!==t){const t=ue(e);if(t)return t}if("outputs"in e){const t=Number(a.get("X-Amzn-Bedrock-Input-Token-Count"))||0,o=Number(a.get("X-Amzn-Bedrock-Output-Token-Count"))||0;return{id:Date.now().toString(),object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:E,choices:[{text:e.outputs[0].text,index:0,logprobs:null,finish_reason:e.outputs[0].stop_reason}],usage:{prompt_tokens:t,completion_tokens:o,total_tokens:t+o}}}return W(e,E)},Le={input:{param:"texts",required:!0,transform:e=>Array.isArray(e.input)?e.input:[e.input]},input_type:{param:"input_type",required:!0},truncate:{param:"truncate"}},Ke={input:{param:"inputText",required:!0}},He=(e,t)=>{if(200!==t){const t=ue(e);if(t)return t}return"embedding"in e?{object:"list",data:[{object:"embedding",embedding:e.embedding,index:0}],provider:E,model:"",usage:{prompt_tokens:e.inputTextTokenCount,total_tokens:e.inputTextTokenCount}}:W(e,E)},Ge=(e,t,a)=>{if(200!==t){const t=ue(e);if(t)return t}return"embeddings"in e?{object:"list",data:e.embeddings.map(((e,t)=>({object:"embedding",embedding:e,index:t}))),provider:E,model:"",usage:{prompt_tokens:Number(a.get("X-Amzn-Bedrock-Input-Token-Count"))||-1,total_tokens:Number(a.get("X-Amzn-Bedrock-Input-Token-Count"))||-1}}:W(e,E)},We={prompt:{param:"text_prompts",required:!0,transform:e=>[{text:e.prompt,weight:1}]},n:{param:"samples",min:1,max:10},size:[{param:"height",transform:e=>parseInt(e.size.toLowerCase().split("x")[1]),min:320},{param:"width",transform:e=>parseInt(e.size.toLowerCase().split("x")[0]),min:320}],style:{param:"style_preset"}},Xe=(e,t)=>{if(200!==t){const t=ue(e);if(t)return t}return"artifacts"in e?{created:`${(new Date).getTime()}`,data:e.artifacts.map((e=>({b64_json:e.base64}))),provider:E}:W(e,E)},Fe={api:ne,getConfig:e=>{const t=e.model,a=t?.split(".")[0];switch(a){case y:return{complete:Ce,chatComplete:se,api:ne,responseTransforms:{"stream-complete":Pe,complete:Je,"stream-chatComplete":ke,chatComplete:xe}};case h:return{complete:je,chatComplete:ie,embed:Le,api:ne,responseTransforms:{"stream-complete":ze,complete:Ie,"stream-chatComplete":ve,chatComplete:be,embed:Ge}};case"meta":return{complete:qe,chatComplete:pe,api:ne,responseTransforms:{"stream-complete":Ae,complete:Ee,"stream-chatComplete":ge,chatComplete:fe}};case"mistral":return{complete:Te,chatComplete:me,api:ne,responseTransforms:{"stream-complete":Be,complete:Ue,"stream-chatComplete":Oe,chatComplete:we}};case"amazon":return{complete:$e,chatComplete:le,embed:Ke,api:ne,responseTransforms:{"stream-complete":De,complete:Re,"stream-chatComplete":_e,chatComplete:he,embed:He}};case N:return{complete:Ne,chatComplete:de,api:ne,responseTransforms:{complete:Me,chatComplete:ye}};case"stability":return{imageGenerate:We,api:ne,responseTransforms:{imageGenerate:Xe}}}}},Ve={complete:{model:{param:"model",default:"command",required:!0},prompt:{param:"prompt",required:!0},max_tokens:{param:"max_tokens",default:20,min:1},temperature:{param:"temperature",default:.75,min:0,max:5},top_p:{param:"p",default:.75,min:0,max:1},top_k:{param:"k",default:0,max:500},frequency_penalty:{param:"frequency_penalty",default:0,min:0,max:1},presence_penalty:{param:"presence_penalty",default:0,min:0,max:1},logit_bias:{param:"logit_bias"},n:{param:"num_generations",default:1,min:1,max:5},stop:{param:"end_sequences"},stream:{param:"stream",default:!1}},chatComplete:{model:{param:"model",default:"command",required:!0},messages:{param:"prompt",required:!0,transform:e=>{let t="";if(e.messages){e.messages.forEach((e=>{t+=`${e.role}:${e.content}\n`})),t=t.trim()}return t}},max_tokens:{param:"max_tokens",default:20,min:1},temperature:{param:"temperature",default:.75,min:0,max:5},top_p:{param:"p",default:.75,min:0,max:1},top_k:{param:"k",default:0,max:500},frequency_penalty:{param:"frequency_penalty",default:0,min:0,max:1},presence_penalty:{param:"presence_penalty",default:0,min:0,max:1},logit_bias:{param:"logit_bias"},n:{param:"num_generations",default:1,min:1,max:5},stop:{param:"end_sequences"},stream:{param:"stream",default:!1}},embed:{input:{param:"texts",required:!0,transform:e=>Array.isArray(e.input)?e.input:[e.input]},model:{param:"model",default:"embed-english-light-v2.0"}},api:{getBaseURL:()=>"https://api.cohere.ai/v1",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>{switch(e){case"chatComplete":case"complete":return"/generate";case"embed":return"/embed";default:return""}}},responseTransforms:{complete:(e,t)=>200!==t?X({message:e.message||"",type:null,param:null,code:null},h):{id:e.id,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"Unknown",provider:h,choices:e.generations.map(((e,t)=>({text:e.text,index:t,logprobs:null,finish_reason:"length"})))},"stream-complete":(e,t)=>{let a=e.trim();a=a.replace(/^data: /,""),a=a.trim();const o=JSON.parse(a);return o.is_finished?"":`data: ${JSON.stringify({id:o.id??t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:h,choices:[{text:o.response?.generations?.[0]?.text??o.text,index:o.index??0,logprobs:null,finish_reason:o.response?.generations?.[0]?.finish_reason??null}]})}\n\n`},chatComplete:(e,t)=>200!==t?X({message:e.message||"",type:null,param:null,code:null},h):{id:e.id,object:"chat_completion",created:Math.floor(Date.now()/1e3),model:"Unknown",provider:h,choices:e.generations.map(((e,t)=>({message:{role:"assistant",content:e.text},index:t,finish_reason:"length"})))},"stream-chatComplete":(e,t)=>{let a=e.trim();a=a.replace(/^data: /,""),a=a.trim();const o=JSON.parse(a);return o.is_finished?"":`data: ${JSON.stringify({id:o.id??t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:h,choices:[{delta:{content:o.response?.generations?.[0]?.text??o.text},index:o.index??0,logprobs:null,finish_reason:o.response?.generations?.[0]?.finish_reason??null}]})}\n\n`},embed:(e,t)=>200!==t?X({message:e.message||"",type:null,param:null,code:null},h):{object:"list",data:e.embeddings.map(((e,t)=>({object:"embedding",embedding:e,index:t}))),model:"",usage:{prompt_tokens:-1,total_tokens:-1}}}},Ye={chatComplete:{model:{param:"model",required:!0,default:"deepinfra/airoboros-70b"},messages:{param:"messages",required:!0,default:[]},frequency_penalty:{param:"frequency_penalty",default:0,min:-2,max:2},max_tokens:{param:"max_tokens",default:100,min:1},n:{param:"n",default:1,min:1,max:1},presence_penalty:{param:"presence_penalty",min:-2,max:2,default:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},stop:{param:"stop",default:null},stream:{param:"stream",default:!1}},api:{getBaseURL:()=>"https://api.deepinfra.com/v1/openai",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>"chatComplete"===e?"/chat/completions":""},responseTransforms:{chatComplete:(e,t)=>{if("detail"in e&&200!==t&&e.detail.length){let t,a,o=null,r=null;return Array.isArray(e.detail)?([t]=e.detail,o=t?.loc?.join(".")??"",a=t.msg,r=t.type):a=e.detail,X({message:`${o?`${o}: `:""}${a}`,type:r,param:null,code:null},q)}return"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:q,choices:e.choices.map((e=>({index:e.index,message:{role:e.message.role,content:e.message.content},finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens,completion_tokens:e.usage?.completion_tokens,total_tokens:e.usage?.total_tokens}}:W(e,q)},"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:q,choices:[{index:a.choices[0].index,delta:a.choices[0].delta,finish_reason:a.choices[0].finish_reason}]})}\n\n`}}},Qe=e=>{const t={};return e.temperature&&(t.temperature=e.temperature),e.top_p&&(t.topP=e.top_p),e.top_k&&(t.topK=e.top_k),e.max_tokens&&(t.maxOutputTokens=e.max_tokens),e.stop&&(t.stopSequences=e.stop),t},Ze=["gemini-1.0-pro","gemini-1.0-pro-001","gemini-1.0-pro-latest","gemini-1.0-pro-vision-latest","gemini-pro","gemini-pro-vision"],et=e=>{switch(e){case"assistant":return"model";case"tool":return"function";default:return e}},tt=e=>{if("object"==typeof e&&"function"===e.type)return"ANY";if("string"==typeof e)switch(e){case"auto":return"AUTO";case"none":return"NONE";case"required":return"ANY"}},at=(e,t=v)=>{if("error"in e)return X({message:e.error.message??"",type:e.error.status??null,param:null,code:e.error.status??null},t)},ot={api:{getBaseURL:()=>"https://generativelanguage.googleapis.com/v1beta",headers:()=>({"Content-Type":"application/json"}),getEndpoint:({fn:e,providerOptions:t,gatewayRequestBody:a})=>{let o=e;const{model:r,stream:n}=a,{apiKey:s}=t;switch(n&&(o=`stream-${e}`),o){case"chatComplete":return`/models/${r}:generateContent?key=${s}`;case"stream-chatComplete":return`/models/${r}:streamGenerateContent?key=${s}`;case"embed":return`/models/${r}:embedContent?key=${s}`;default:return""}}},chatComplete:{model:{param:"model",required:!0,default:"gemini-pro"},messages:[{param:"contents",default:"",transform:e=>{let t;const a=[];return e.messages?.forEach((o=>{if("system"===o.role&&!Ze.includes(e.model))return;const r=et(o.role);let n=[];"assistant"===o.role&&o.tool_calls?o.tool_calls.forEach((e=>{n.push({functionCall:{name:e.function.name,args:JSON.parse(e.function.arguments)}})})):"tool"===o.role&&"string"==typeof o.content?n.push({functionResponse:{name:o.name??"gateway-tool-filler-name",response:{content:o.content}}}):o.content&&"object"==typeof o.content?o.content.forEach((e=>{"text"===e.type&&n.push({text:e.text}),"image_url"===e.type&&n.push({inlineData:{mimeType:"image/jpeg",data:e.image_url?.url}})})):"string"==typeof o.content&&n.push({text:o.content});"user"===t&&"user"===r&&!e.model?.includes("vision")&&a.push({role:"model",parts:[{text:""}]}),a.push({role:r,parts:n}),t=r})),a}},{param:"systemInstruction",default:"",transform:e=>{if(Ze.includes(e.model))return;const t=e.messages?.[0]||null;return t?"system"===t.role&&"string"==typeof t.content?{parts:[{text:t.content}],role:"system"}:"system"===t.role&&"object"==typeof t.content&&t.content?.[0]?.text?{parts:[{text:t.content?.[0].text}],role:"system"}:void 0:void 0}}],temperature:{param:"generationConfig",transform:e=>Qe(e)},top_p:{param:"generationConfig",transform:e=>Qe(e)},top_k:{param:"generationConfig",transform:e=>Qe(e)},max_tokens:{param:"generationConfig",transform:e=>Qe(e)},stop:{param:"generationConfig",transform:e=>Qe(e)},tools:{param:"tools",default:"",transform:e=>{const t=[];return e.tools?.forEach((e=>{"function"===e.type&&t.push(e.function)})),{functionDeclarations:t}}},tool_choice:{param:"tool_config",default:"",transform:e=>{if(e.tool_choice){const t=[];"object"==typeof e.tool_choice&&"function"===e.tool_choice.type&&t.push(e.tool_choice.function.name);const a={function_calling_config:{mode:tt(e.tool_choice)}};return t.length>0&&(a.function_calling_config.allowed_function_names=t),a}}}},embed:{input:{param:"content",required:!0,transform:e=>{const t=[];return Array.isArray(e.input)?e.input.forEach((e=>{t.push({text:e})})):t.push({text:e.input}),{parts:t}}},model:{param:"model",required:!0,default:"embedding-001"}},responseTransforms:{chatComplete:(e,t)=>{if(200!==t){const t=at(e);if(t)return t}return"candidates"in e?{id:"portkey-"+crypto.randomUUID(),object:"chat_completion",created:Math.floor(Date.now()/1e3),model:"Unknown",provider:"google",choices:e.candidates?.map(((e,t)=>{let a={role:"assistant",content:""};return e.content.parts[0]?.text?a={role:"assistant",content:e.content.parts[0]?.text}:e.content.parts[0]?.functionCall&&(a={role:"assistant",tool_calls:e.content.parts.map((e=>{if(e.functionCall)return{id:"portkey-"+crypto.randomUUID(),type:"function",function:{name:e.functionCall.name,arguments:JSON.stringify(e.functionCall.args)}}}))}),{message:a,index:e.index,finish_reason:e.finishReason}}))??[],usage:{prompt_tokens:e.usageMetadata.promptTokenCount,completion_tokens:e.usageMetadata.candidatesTokenCount,total_tokens:e.usageMetadata.totalTokenCount}}:W(e,v)},"stream-chatComplete":(e,t)=>{let a=e.trim();if(a.startsWith("[")&&(a=a.slice(1)),a.endsWith(",")&&(a=a.slice(0,a.length-1)),a.endsWith("]")&&(a=a.slice(0,a.length-2)),a=a.replace(/^data: /,""),a=a.trim(),"[DONE]"===a)return`data: ${a}\n\n`;const o=JSON.parse(a);return`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:"google",choices:o.candidates?.map(((e,t)=>{let a={role:"assistant",content:""};return e.content.parts[0]?.text?a={role:"assistant",content:e.content.parts[0]?.text}:e.content.parts[0]?.functionCall&&(a={role:"assistant",tool_calls:e.content.parts.map(((e,t)=>{if(e.functionCall)return{index:t,id:"portkey-"+crypto.randomUUID(),type:"function",function:{name:e.functionCall.name,arguments:JSON.stringify(e.functionCall.args)}}}))}),{delta:a,index:e.index,finish_reason:e.finishReason}}))??[],usage:{prompt_tokens:o.usageMetadata.promptTokenCount,completion_tokens:o.usageMetadata.candidatesTokenCount,total_tokens:o.usageMetadata.totalTokenCount}})}\n\n`},embed:(e,t)=>{if(200!==t){const t=at(e);if(t)return t}return"embedding"in e?{object:"list",data:[{object:"embedding",embedding:e.embedding.values,index:0}],model:"",usage:{prompt_tokens:-1,total_tokens:-1}}:W(e,v)}}};function rt(e){return btoa(JSON.stringify(e)).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}const nt=async e=>{try{const t="https://www.googleapis.com/auth/cloud-platform",a=Math.floor(Date.now()/1e3),o=a+3600,r={iss:e.client_email,sub:e.client_email,aud:"https://oauth2.googleapis.com/token",iat:a,exp:o,scope:t},n={alg:"RS256",typ:"JWT",kid:e.private_key_id},s=await async function(e){const t=e.replace(/-----BEGIN PRIVATE KEY-----/g,"").replace(/-----END PRIVATE KEY-----/g,"").replace(/\s+/g,""),a=atob(t),o=new Uint8Array(a.length);for(let e=0;e<a.length;e++)o[e]=a.charCodeAt(e);return crypto.subtle.importKey("pkcs8",o.buffer,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"])}(e.private_key),i=await(async(e,t,a)=>{const o=rt(e),r=rt(t),n=(new TextEncoder).encode(`${o}.${r}`),s=await crypto.subtle.sign({name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},a,n);return`${o}.${r}.${btoa(String.fromCharCode(...new Uint8Array(s))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}`})(n,r,s),p="https://oauth2.googleapis.com/token",m={"Content-Type":"application/x-www-form-urlencoded"},c=new URLSearchParams({grant_type:"urn:ietf:params:oauth:grant-type:jwt-bearer",assertion:i}),l=await fetch(p,{headers:m,body:c,method:"POST"});return(await l.json()).access_token}catch(e){return""}},st=e=>{let t="google",a=e;const o=e.split(".");return o.length>1&&["google","anthropic"].includes(o[0])&&(t=o[0],a=o.slice(1).join(".")),{provider:t,model:a}},it={getBaseURL:({providerOptions:e})=>{const{vertexProjectId:t,vertexRegion:a,vertexServiceAccountJson:o}=e;let r=t;return o&&(r=o.project_id),`https://${a}-aiplatform.googleapis.com/v1/projects/${r}/locations/${a}`},headers:async({providerOptions:e})=>{const{apiKey:t,vertexServiceAccountJson:a}=e;let o=t;return a&&(o=await nt(a)),{"Content-Type":"application/json",Authorization:`Bearer ${o}`}},getEndpoint:({fn:e,gatewayRequestBody:t})=>{let a=e;const{model:o,stream:r}=t;r&&(a=`stream-${e}`);const{provider:n,model:s}=st(o);switch(n){case"google":if("chatComplete"===a)return`/publishers/${n}/models/${s}:generateContent`;if("stream-chatComplete"===a)return`/publishers/${n}/models/${s}:streamGenerateContent?alt=sse`;case"anthropic":if("chatComplete"===a)return`/publishers/${n}/models/${s}:rawPredict`;if("stream-chatComplete"===a)return`/publishers/${n}/models/${s}:streamRawPredict`;default:return""}}};function pt(e){const t={};return e.temperature&&(t.temperature=e.temperature),e.top_p&&(t.topP=e.top_p),e.top_k&&(t.topK=e.top_k),e.max_tokens&&(t.maxOutputTokens=e.max_tokens),e.stop&&(t.stopSequences=e.stop),"json_object"===e?.response_format?.type&&(t.responseMimeType="application/json"),t}const mt={model:{param:"model",required:!0,default:"gemini-1.0-pro"},messages:[{param:"contents",default:"",transform:e=>{let t;const a=[];return e.messages?.forEach((o=>{if("system"===o.role&&!Ze.includes(e.model))return;const r=et(o.role);let n=[];"assistant"===o.role&&o.tool_calls?o.tool_calls.forEach((e=>{n.push({functionCall:{name:e.function.name,args:JSON.parse(e.function.arguments)}})})):"tool"===o.role&&"string"==typeof o.content?n.push({functionResponse:{name:o.name??"gateway-tool-filler-name",response:{content:o.content}}}):o.content&&"object"==typeof o.content?o.content.forEach((e=>{if("text"===e.type&&n.push({text:e.text}),"image_url"===e.type){const{url:t}=e.image_url||{};if(!t)return;if(t.startsWith("data:")){const[e,a]=t.split(";base64,"),o=e.split(":")[1];return void n.push({inlineData:{mimeType:o,data:a}})}n.push({fileData:{mimeType:"image/jpeg",fileUri:t}})}})):"string"==typeof o.content&&n.push({text:o.content});t===r&&!e.model?.includes("vision")?a[a.length-1].parts.push(...n):a.push({role:r,parts:n}),t=r})),a}},{param:"systemInstruction",default:"",transform:e=>{if(Ze.includes(e.model))return;const t=e.messages?.[0]||null;return t?"system"===t.role&&"string"==typeof t.content?{parts:[{text:t.content}],role:"system"}:"system"===t.role&&"object"==typeof t.content&&t.content?.[0]?.text?{parts:[{text:t.content?.[0].text}],role:"system"}:void 0:void 0}}],temperature:{param:"generationConfig",transform:e=>pt(e)},top_p:{param:"generationConfig",transform:e=>pt(e)},top_k:{param:"generationConfig",transform:e=>pt(e)},max_tokens:{param:"generationConfig",transform:e=>pt(e)},stop:{param:"generationConfig",transform:e=>pt(e)},response_format:{param:"generationConfig",transform:e=>pt(e)},safety_settings:{param:"safety_settings"},tools:{param:"tools",default:"",transform:e=>{const t=[];return e.tools?.forEach((e=>{"function"===e.type&&t.push(e.function)})),{functionDeclarations:t}}},tool_choice:{param:"tool_config",default:"",transform:e=>{if(e.tool_choice){const t=[];"object"==typeof e.tool_choice&&"function"===e.tool_choice.type&&t.push(e.tool_choice.function.name);const a={function_calling_config:{mode:tt(e.tool_choice)}};return t.length>0&&(a.function_calling_config.allowed_function_names=t),a}}}},ct={messages:[{param:"messages",required:!0,transform:e=>{let t=[];return e.messages&&e.messages.forEach((e=>{if("system"!==e.role)if("assistant"===e.role)t.push((e=>{let t=[];const a=e.tool_calls&&e.tool_calls.length;return e.content&&"string"==typeof e.content?t.push({type:"text",text:e.content}):e.content&&"object"==typeof e.content&&e.content.length&&e.content[0].text&&t.push({type:"text",text:e.content[0].text}),a&&e.tool_calls.forEach((e=>{t.push({type:"tool_use",name:e.function.name,id:e.id,input:JSON.parse(e.function.arguments)})})),{role:e.role,content:t}})(e));else if(e.content&&"object"==typeof e.content&&e.content.length){const a={role:e.role,content:[]};e.content.forEach((e=>{if("text"===e.type)a.content.push({type:e.type,text:e.text});else if("image_url"===e.type&&e.image_url&&e.image_url.url){const t=e.image_url.url.split(";");if(2===t.length){const e=t[1].split(",")[1],o=t[0].split(":");if(2===o.length&&e){const t=o[1];a.content.push({type:"image",source:{type:"base64",media_type:t,data:e}})}}}})),t.push(a)}else"tool"===e.role?t.push((e=>({role:"user",content:[{type:"tool_result",tool_use_id:e.tool_call_id,content:e.content}]}))(e)):t.push({role:e.role,content:e.content})})),t}},{param:"system",required:!1,transform:e=>{let t="";return e.messages&&e.messages.forEach((e=>{"system"===e.role&&e.content&&"object"==typeof e.content&&e.content[0].text?t=e.content[0].text:"system"===e.role&&"string"==typeof e.content&&(t=e.content)})),t}}],tools:{param:"tools",required:!1,transform:e=>{let t=[];return e.tools&&e.tools.forEach((e=>{e.function&&t.push({name:e.function.name,description:e.function?.description||"",input_schema:{type:e.function.parameters?.type||"object",properties:e.function.parameters?.properties||{},required:e.function.parameters?.required||[]}})})),t}},tool_choice:{param:"tool_choice",required:!1,transform:e=>{if(e.tool_choice)if("string"==typeof e.tool_choice){if("required"===e.tool_choice)return{type:"any"};if("auto"===e.tool_choice)return{type:"auto"}}else if("object"==typeof e.tool_choice)return{type:"tool",name:e.tool_choice.function.name};return null}},max_tokens:{param:"max_tokens",required:!0},temperature:{param:"temperature",default:1,min:0,max:1},top_p:{param:"top_p",default:-1,min:-1},top_k:{param:"top_k",default:-1},stop:{param:"stop_sequences"},stream:{param:"stream",default:!1},user:{param:"metadata.user_id"},anthropic_version:{param:"anthropic_version",required:!0,default:"vertex-2023-10-16"}},lt=(e,t)=>{if(200!==t&&Array.isArray(e)&&e.length>0&&"error"in e[0]){const{error:t}=e[0];return X({message:t.message,type:t.status,param:null,code:String(t.code)},w)}if(200!==t&&"error"in e){const{error:t}=e;return X({message:t.message,type:t.status,param:null,code:String(t.code)},w)}if("candidates"in e&&"PROHIBITED_CONTENT"===e.candidates[0].finishReason)return W(e,w);if("candidates"in e){const{promptTokenCount:t=0,candidatesTokenCount:a=0,totalTokenCount:o=0}=e.usageMetadata;return{id:"portkey-"+crypto.randomUUID(),object:"chat_completion",created:Math.floor(Date.now()/1e3),model:"Unknown",provider:w,choices:e.candidates?.map(((e,t)=>{let a={role:"assistant",content:""};return e.content.parts[0]?.text?a={role:"assistant",content:e.content.parts[0]?.text}:e.content.parts[0]?.functionCall&&(a={role:"assistant",tool_calls:e.content.parts.map((e=>{if(e.functionCall)return{id:"portkey-"+crypto.randomUUID(),type:"function",function:{name:e.functionCall.name,arguments:JSON.stringify(e.functionCall.args)}}}))}),{message:a,index:t,finish_reason:e.finishReason}}))??[],usage:{prompt_tokens:t,completion_tokens:a,total_tokens:o}}}return W(e,w)},dt=(e,t)=>{const a=e.trim().replace(/^data: /,"").trim();if("[DONE]"===a)return`data: ${a}\n\n`;let o,r=JSON.parse(a);r.usageMetadata&&(o={prompt_tokens:r.usageMetadata.promptTokenCount,completion_tokens:r.usageMetadata.candidatesTokenCount,total_tokens:r.usageMetadata.totalTokenCount});const n={id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:w,choices:r.candidates?.map(((e,t)=>{let a={role:"assistant",content:""};return e.content.parts[0]?.text?a={role:"assistant",content:e.content.parts[0]?.text}:e.content.parts[0]?.functionCall&&(a={role:"assistant",tool_calls:e.content.parts.map(((e,t)=>{if(e.functionCall)return{index:t,id:"portkey-"+crypto.randomUUID(),type:"function",function:{name:e.functionCall.name,arguments:JSON.stringify(e.functionCall.args)}}}))}),{delta:a,index:t,finish_reason:e.finishReason}}))??[],usage:o};return`data: ${JSON.stringify(n)}\n\n`},ut=(e,t)=>{if(200!==t){const t=(e=>{if("error"in e)return X({message:e.error?.message,type:e.error?.type,param:null,code:null},w)})(e);if(t)return t}if("content"in e){const{input_tokens:t=0,output_tokens:a=0}=e?.usage;let o="";e.content.length&&"text"===e.content[0].type&&(o=e.content[0].text);let r=[];return e.content.forEach((e=>{"tool_use"===e.type&&r.push({id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.input)}})})),{id:e.id,object:"chat_completion",created:Math.floor(Date.now()/1e3),model:e.model,provider:w,choices:[{message:{role:"assistant",content:o,tool_calls:r.length?r:void 0},index:0,logprobs:null,finish_reason:e.stop_reason}],usage:{prompt_tokens:t,completion_tokens:a,total_tokens:t+a}}}return W(e,w)},ft=(e,t,a)=>{let o=e.trim();if(o.startsWith("event: ping")||o.startsWith("event: content_block_stop")||o.startsWith("event: vertex_event"))return;if(o.startsWith("event: message_stop"))return"data: [DONE]\n\n";o=o.replace(/^event: content_block_delta[\r\n]*/,""),o=o.replace(/^event: content_block_start[\r\n]*/,""),o=o.replace(/^event: message_delta[\r\n]*/,""),o=o.replace(/^event: message_start[\r\n]*/,""),o=o.replace(/^data: /,""),o=o.trim();const r=JSON.parse(o);if("content_block_start"===r.type&&"text"===r.content_block?.type)return void(a.containsChainOfThoughtMessage=!0);if("message_start"===r.type&&r.message?.usage)return`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:w,choices:[{delta:{content:""},index:0,logprobs:null,finish_reason:null}],usage:{prompt_tokens:r.message?.usage?.input_tokens}})}\n\n`;if("message_delta"===r.type&&r.usage)return`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:w,choices:[{index:0,delta:{},finish_reason:r.delta?.stop_reason}],usage:{completion_tokens:r.usage?.output_tokens}})}\n\n`;const n=[],s="content_block_start"===r.type&&!!r.content_block?.id,i="content_block_delta"===r.type&&!!r.delta.partial_json,p=a.containsChainOfThoughtMessage?r.index-1:r.index;return s&&r.content_block?n.push({index:p,id:r.content_block.id,type:"function",function:{name:r.content_block.name,arguments:""}}):i&&n.push({index:p,function:{arguments:r.delta.partial_json}}),`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:w,choices:[{delta:{content:r.delta?.text,tool_calls:n.length?n:void 0},index:0,logprobs:null,finish_reason:r.delta?.stop_reason??null}]})}\n\n`},gt={api:it,getConfig:e=>{const t=e.model,{provider:a}=st(t);switch(a){case"google":return{chatComplete:mt,api:it,responseTransforms:{"stream-chatComplete":dt,chatComplete:lt}};case"anthropic":return{chatComplete:ct,api:it,responseTransforms:{"stream-chatComplete":ft,chatComplete:ut}}}}},ht={chatComplete:{model:{param:"model",required:!0,default:"mistral-tiny"},messages:{param:"messages",default:[]},temperature:{param:"temperature",default:.7,min:0,max:1},top_p:{param:"top_p",default:1,min:0,max:1},max_tokens:{param:"max_tokens",default:null,min:1},stream:{param:"stream",default:!1},seed:{param:"random_seed",default:null},safe_prompt:{param:"safe_prompt",default:!1},safe_mode:{param:"safe_prompt",default:!1}},embed:{model:{param:"model",required:!0,default:"mistral-embed"},input:{param:"input",required:!0,transform:e=>Array.isArray(e.input)?e.input:[e.input]}},api:{getBaseURL:()=>"https://api.mistral.ai/v1",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>{switch(e){case"chatComplete":return"/chat/completions";case"embed":return"/embeddings";default:return""}}},responseTransforms:{chatComplete:(e,t)=>"message"in e&&200!==t?X({message:e.message,type:e.type,param:e.param,code:e.code},j):"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:j,choices:e.choices.map((e=>({index:e.index,message:{role:e.message.role,content:e.message.content},finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens,completion_tokens:e.usage?.completion_tokens,total_tokens:e.usage?.total_tokens}}:W(e,j),"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:j,choices:[{index:a.choices[0].index,delta:a.choices[0].delta,finish_reason:a.choices[0].finish_reason}]})}\n\n`},embed:(e,t)=>"message"in e&&200!==t?X({message:e.message,type:e.type,param:e.param,code:e.code},j):"data"in e?{object:e.object,data:e.data.map((e=>({object:e.object,embedding:e.embedding,index:e.index}))),model:e.model,usage:{prompt_tokens:e.usage.prompt_tokens,total_tokens:e.usage.total_tokens},provider:j}:W(e,j)}},_t={embed:{model:{param:"model",required:!0,default:"nomic-embed-text-v1"},input:{param:"texts",required:!0,transform:e=>Array.isArray(e.input)?e.input:[e.input]},task_type:{param:"task_type"}},api:{getBaseURL:()=>"https://api-atlas.nomic.ai/v1",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>"embed"===e?"/embedding/text":""},responseTransforms:{embed:(e,t)=>"detail"in e&&200!==t&&e.detail.length?(e=>{let t,a,o=null,r=null;return Array.isArray(e.detail)?([t]=e.detail,o=t?.loc?.join(".")??"",a=t.msg,r=t.type):a=e.detail,X({message:`${o?`${o}: `:""}${a}`,type:r,param:null,code:null},S)})(e):"embeddings"in e?{object:"list",data:e.embeddings.map(((e,t)=>({object:"embedding",embedding:e,index:t}))),model:e.model,usage:{prompt_tokens:e.usage.prompt_tokens,total_tokens:e.usage.total_tokens},provider:S}:W(e,S)}},yt=(e,t)=>{const a=[],{id:o,model:r,choices:n}=e,{prompt_tokens:s,completion_tokens:i}=e.usage||{};let p;s&&i&&(p=s+i);const m={id:o,object:"text_completion",created:Date.now(),model:r??"",provider:t,usage:{...i&&{completion_tokens:i},...s&&{prompt_tokens:s},...p&&{total_tokens:p}}};for(const[e,t]of n.entries()){if(t.text){const o=[];for(let e=0;e<t.text.length;e+=4)o.push(t.text.slice(e,e+4));o.forEach((t=>{a.push(`data: ${JSON.stringify({...m,choices:[{index:e,text:t}]})}\n\n`)}))}a.push(`data: ${JSON.stringify({...m,choices:[{index:e,text:"",finish_reason:t.finish_reason}]})}\n\n`)}return a.push("data: [DONE]\n\n"),a},xt={complete:{model:{param:"model",required:!0,default:"text-davinci-003"},prompt:{param:"prompt",default:""},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},n:{param:"n",default:1},stream:{param:"stream",default:!1},logprobs:{param:"logprobs",max:5},echo:{param:"echo",default:!1},stop:{param:"stop"},presence_penalty:{param:"presence_penalty",min:-2,max:2},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},best_of:{param:"best_of"},logit_bias:{param:"logit_bias"},user:{param:"user"},seed:{param:"seed"},suffix:{param:"suffix"}},embed:{model:{param:"model",required:!0,default:"text-embedding-ada-002"},input:{param:"input",required:!0},encoding_format:{param:"encoding_format"},dimensions:{param:"dimensions"},user:{param:"user"}},api:{getBaseURL:()=>"https://api.openai.com/v1",headers:({providerOptions:e})=>{const t={Authorization:`Bearer ${e.apiKey}`};return e.openaiOrganization&&(t["OpenAI-Organization"]=e.openaiOrganization),e.openaiProject&&(t["OpenAI-Project"]=e.openaiProject),t},getEndpoint:({fn:e})=>{switch(e){case"complete":return"/completions";case"chatComplete":return"/chat/completions";case"embed":return"/embeddings";case"imageGenerate":return"/images/generations";default:return""}}},chatComplete:{model:{param:"model",required:!0,default:"gpt-3.5-turbo"},messages:{param:"messages",default:""},functions:{param:"functions"},function_call:{param:"function_call"},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},n:{param:"n",default:1},stream:{param:"stream",default:!1},stop:{param:"stop"},presence_penalty:{param:"presence_penalty",min:-2,max:2},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},logit_bias:{param:"logit_bias"},user:{param:"user"},seed:{param:"seed"},tools:{param:"tools"},tool_choice:{param:"tool_choice"},response_format:{param:"response_format"},logprobs:{param:"logprobs",default:!1},top_logprobs:{param:"top_logprobs"},stream_options:{param:"stream_options"}},imageGenerate:{prompt:{param:"prompt",required:!0},model:{param:"model",required:!0,default:"dall-e-2"},n:{param:"n",min:1,max:10},quality:{param:"quality"},response_format:{param:"response_format"},size:{param:"size"},style:{param:"style"},user:{param:"user"}},responseTransforms:{complete:(e,t)=>200!==t&&"error"in e?ae(e,g):e,chatComplete:(e,t)=>200!==t&&"error"in e?ae(e,g):e,embed:(e,t)=>200!==t&&"error"in e?ae(e,g):e,imageGenerate:(e,t)=>200!==t&&"error"in e?ae(e,g):e}},kt={complete:{model:{param:"model",required:!0,default:"model/text-bison-001"},prompt:{param:"prompt",default:"",transform:e=>{const{prompt:t}=e;return{text:t}}},temperature:{param:"temperature",default:1,min:0,max:1},top_p:{param:"topP",default:1,min:0,max:1},top_k:{param:"topK",default:1,min:0,max:1},n:{param:"candidateCount",default:1,min:1,max:8},max_tokens:{param:"maxOutputTokens",default:100,min:1},stop:{param:"stopSequences"}},embed:{input:{param:"text",required:!0},model:{param:"model",default:"models/embedding-gecko-001"}},api:{getBaseURL:()=>"https://generativelanguage.googleapis.com/v1beta3",headers:()=>({"Content-Type":"application/json"}),getEndpoint:({providerOptions:e,fn:t,gatewayRequestBody:a})=>{const{apiKey:o}=e,{model:r}=a;switch(t){case"complete":return`/models/${r}:generateText?key=${o}`;case"chatComplete":return`/models/${r}:generateMessage?key=${o}`;case"embed":return`/models/${r}:embedText?key=${o}`;default:return""}}},chatComplete:{model:{param:"model",required:!0,default:"model/chat-bison-001"},messages:{param:"prompt",default:"",transform:e=>{const{examples:t,context:a,messages:o}=e,r=o?.map((e=>({author:e.role,content:e.content})));return{messages:r,examples:t,context:a}}},temperature:{param:"temperature",default:1,min:0,max:1},top_p:{param:"topP",default:1,min:0,max:1},top_k:{param:"topK",default:1,min:0,max:1},n:{param:"candidateCount",default:1,min:1,max:8},max_tokens:{param:"maxOutputTokens",default:100,min:1},stop:{param:"stopSequences"}},responseTransforms:{complete:(e,t)=>{if(200!==t){const t=at(e,k);if(t)return t}return"candidates"in e?{id:Date.now().toString(),object:"completion",created:Math.floor(Date.now()/1e3),model:"Unknown",provider:k,choices:e.candidates?.map(((e,t)=>({text:e.output,index:t,logprobs:null,finish_reason:"length"})))??[]}:W(e,k)},chatComplete:(e,t)=>{if(200!==t){const t=at(e,k);if(t)return t}return"candidates"in e?{id:Date.now().toString(),object:"chat_completion",created:Math.floor(Date.now()/1e3),model:"Unknown",provider:k,choices:e.candidates?.map(((e,t)=>({message:{role:"assistant",content:e.content},index:t,finish_reason:"length"})))??[]}:W(e,k)},embed:(e,t)=>{if(200!==t){const t=at(e,k);if(t)return t}return"embedding"in e?{object:"list",data:[{object:"embedding",embedding:e.embedding.value,index:0}],model:"",usage:{prompt_tokens:-1,total_tokens:-1},provider:k}:W(e,k)}}},bt={chatComplete:{model:{param:"model",required:!0,default:"mistral-7b-instruct"},messages:{param:"messages",required:!0,default:[]},max_tokens:{param:"max_tokens",required:!0,min:1},temperature:{param:"temperature",min:0,max:2},top_p:{param:"top_p",min:0,max:1},top_k:{param:"top_k",min:0,max:2048},stream:{param:"stream",default:!1},presence_penalty:{param:"presence_penalty",min:-2,max:2},frequency_penalty:{param:"repetition_penalty"},n:{param:"n",max:1,min:1}},api:{getBaseURL:()=>"https://api.perplexity.ai",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>"chatComplete"===e?"/chat/completions":""},responseTransforms:{chatComplete:(e,t)=>"error"in e?X({message:e.error.message,type:e.error.type,param:null,code:e.error.code.toString()},O):"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:O,choices:[{message:{role:"assistant",content:e.choices[0]?.message.content},index:0,logprobs:null,finish_reason:""}],usage:{prompt_tokens:e.usage.prompt_tokens,completion_tokens:e.usage.completion_tokens,total_tokens:e.usage.total_tokens}}:W(e,O),"stream-chatComplete":e=>{let t=e.trim();t=t.replace(/^data: /,""),t=t.trim();const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:Math.floor(Date.now()/1e3),model:a.model,provider:O,choices:[{delta:{role:a.choices[0]?.delta.role,content:a.choices[0]?.delta.content},index:0,finish_reason:a.choices[0]?.finish_reason}]})}\n\n`}}},vt=e=>"error"in e&&"string"==typeof e.error?X({message:e.error,type:null,param:null,code:null},b):"error"in e&&"object"==typeof e.error?X({message:e.error?.message||"",type:e.error?.type||null,param:e.error?.param||null,code:e.error?.code||null},b):!(!("message"in e)||!e.message)&&X({message:e.message,type:e.type||null,param:null,code:null},b),wt={complete:{model:{param:"model",required:!0,default:"togethercomputer/RedPajama-INCITE-7B-Instruct"},prompt:{param:"prompt",required:!0,default:""},max_tokens:{param:"max_tokens",required:!0,default:128,min:1},stop:{param:"stop"},temperature:{param:"temperature"},top_p:{param:"top_p"},top_k:{param:"top_k"},frequency_penalty:{param:"repetition_penalty"},stream:{param:"stream",default:!1},logprobs:{param:"logprobs"}},chatComplete:{model:{param:"model",required:!0,default:"togethercomputer/RedPajama-INCITE-Chat-3B-v1"},messages:{param:"messages",required:!0,default:""},max_tokens:{param:"max_tokens",required:!0,default:128,min:1},stop:{param:"stop"},temperature:{param:"temperature"},top_p:{param:"top_p"},top_k:{param:"top_k"},frequency_penalty:{param:"repetition_penalty"},stream:{param:"stream",default:!1},logprobs:{param:"logprobs"},tools:{param:"tools"},tool_choice:{param:"tool_choice"},response_format:{param:"response_format"}},embed:{model:{param:"model",required:!0,default:"mistral-embed"},input:{param:"input",required:!0,transform:e=>Array.isArray(e.input)?e.input:[e.input]}},api:{getBaseURL:()=>"https://api.together.xyz",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>{switch(e){case"complete":return"/v1/completions";case"chatComplete":return"/v1/chat/completions";case"embed":return"/v1/embeddings";default:return""}}},responseTransforms:{"stream-complete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:b,choices:[{text:a.choices[0]?.text,index:0,finish_reason:""}]})}\n\n`},complete:(e,t)=>{if(200!==t){const t=vt(e);if(t)return t}return"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:b,choices:e.choices.map((e=>({text:e.text,index:e.index||0,logprobs:null,finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens,completion_tokens:e.usage?.completion_tokens,total_tokens:e.usage?.total_tokens}}:W(e,b)},chatComplete:(e,t)=>{if(200!==t){const t=vt(e);if(t)return t}return"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:b,choices:e.choices.map((e=>({message:{role:"assistant",content:e.message.content,tool_calls:e.message.tool_calls?e.message.tool_calls.map((e=>({id:e.id,type:e.type,function:e.function}))):null},index:0,logprobs:null,finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens,completion_tokens:e.usage?.completion_tokens,total_tokens:e.usage?.total_tokens}}:W(e,b)},"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:Math.floor(Date.now()/1e3),model:"",provider:b,choices:[{delta:{content:a.choices[0]?.delta.content},index:0,finish_reason:""}]})}\n\n`},embed:(e,t)=>{if(200!==t){const t=vt(e);if(t)return t}return"data"in e?{object:e.object,data:e.data.map((e=>({object:e.object,embedding:e.embedding,index:e.index}))),model:e.model,usage:{prompt_tokens:0,total_tokens:0},provider:b}:W(e,b)}}},Ot={api:{getBaseURL:()=>"https://api.stability.ai/v1",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e,gatewayRequestBody:t,providerOptions:a})=>{let o=e;const{urlToFetch:r}=a;return"proxy"===e&&r&&r?.indexOf("text-to-image")>-1&&(o="imageGenerate"),"imageGenerate"===o?`/generation/${t.model}/text-to-image`:""}},imageGenerate:{prompt:{param:"text_prompts",required:!0,transform:e=>[{text:e.prompt,weight:1}]},n:{param:"samples",min:1,max:10},size:[{param:"height",transform:e=>parseInt(e.size.toLowerCase().split("x")[1]),min:320},{param:"width",transform:e=>parseInt(e.size.toLowerCase().split("x")[0]),min:320}],style:{param:"style_preset"},cfg_scale:{param:"cfg_scale"},clip_guidance_preset:{param:"clip_guidance_preset"},sampler:{param:"sampler"},seed:{param:"seed"},steps:{param:"steps"},extras:{param:"extras"}},responseTransforms:{imageGenerate:(e,t)=>200!==t&&"message"in e?X({message:e.message,type:e.name,param:null,code:null},T):"artifacts"in e?{created:`${(new Date).getTime()}`,data:e.artifacts.map((e=>({b64_json:e.base64}))),provider:T}:W(e,T)}},Ct={embed:{model:{param:"model"},input:{param:"prompt",required:!0}},api:{headers:()=>({}),getBaseURL:({providerOptions:e})=>e.customHost??"",getEndpoint:({fn:e,providerOptions:t})=>{let a=e;const{urlToFetch:o}=t;switch("proxy"===e&&o&&o?.indexOf("/api/chat")>-1?a="chatComplete":"proxy"===e&&o&&o?.indexOf("/embeddings")>-1&&(a="embed"),a){case"chatComplete":return"/v1/chat/completions";case"embed":return"/api/embeddings";default:return""}}},chatComplete:{model:{param:"model",required:!0,default:"llama2"},messages:{param:"messages",default:""},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},presence_penalty:{param:"presence_penalty",min:-2,max:2},response_format:{param:"response_format"},seed:{param:"seed"},stop:{param:"stop"},stream:{param:"stream",default:!1},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},max_tokens:{param:"max_tokens",default:100,min:0}},responseTransforms:{chatComplete:(e,t)=>200!==t?X({message:e.error?.message,type:e.error?.type,param:null,code:null},$):{id:e.id,object:e.object,created:e.created,model:e.model,provider:$,choices:e.choices,usage:e.usage},"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:$,choices:a.choices})}\n\n`},embed:(e,t)=>"error"in e?X({message:e.error,type:null,param:null,code:null},$):"embedding"in e?{object:"list",data:[{object:"embedding",embedding:e.embedding,index:0}],model:"",usage:{prompt_tokens:-1,total_tokens:-1}}:W(e,$)}},jt={chatComplete:{model:{param:"model",required:!0,default:"mixtral-8x7b-32768"},messages:{param:"messages",default:""},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},stream:{param:"stream",default:!1},stop:{param:"stop"},n:{param:"n",default:1,max:1,min:1}},api:{getBaseURL:()=>"https://api.groq.com/openai/v1",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>"chatComplete"===e?"/chat/completions":""},responseTransforms:{chatComplete:(e,t)=>"error"in e&&200!==t?X({message:e.error.message,type:e.error.type,param:null,code:e.error.code?.toString()||null},A):"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:A,choices:e.choices.map((e=>({index:e.index,message:e.message,logprobs:e.logprobs,finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens||0,completion_tokens:e.usage?.completion_tokens||0,total_tokens:e.usage?.total_tokens||0}}:W(e,A),"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return a.x_groq&&a.x_groq.usage?`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:A,choices:[{index:a.choices[0].index||0,delta:{},logprobs:null,finish_reason:a.choices[0].index}],usage:{prompt_tokens:a.x_groq.usage.prompt_tokens||0,completion_tokens:a.x_groq.usage.completion_tokens||0,total_tokens:a.x_groq.usage.total_tokens||0}})}\n\n`:`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:A,choices:[{index:a.choices[0].index||0,delta:{role:"assistant",content:a.choices[0].delta.content},logprobs:null,finish_reason:a.choices[0].finish_reason||null}]})}\n\n`}}},qt={prompt:{param:"prompt",required:!0},n:{param:"samples",min:1,max:10,default:1},size:[{param:"img_height",transform:e=>parseInt(e.size.toLowerCase().split("x")[1])},{param:"img_width",transform:e=>parseInt(e.size.toLowerCase().split("x")[0])}],style:{param:"style",default:"base"},steps:{param:"num_inference_steps",default:20,required:!0},negative_prompt:{param:"negative_prompt",default:"out of frame, duplicate, watermark, signature, text, error, deformed"},scheduler:{param:"scheduler",default:"UniPC"},guidance_scale:{param:"guidance_scale",default:7.5},seed:{param:"seed",default:Math.floor(1e9*Math.random())},strength:{param:"strength",default:.75},refiner:{param:"refiner",default:!0},high_noise_fraction:{param:"high_noise_fraction",default:.8},base64:{param:"base64",transform:e=>!0,default:!0,required:!0},control_scale:{param:"control_scale",default:1.8},control_start:{param:"control_start",default:.19},control_end:{param:"control_end",default:1},qr_text:{param:"qr_text",default:"https://portkey.ai"},invert:{param:"invert",default:!1},qr_size:{param:"size",default:768}},Tt=e=>X("fault"in e?{message:e.fault.faultstring,type:null,param:null,code:e.fault.detail.errorcode}:"detail"in e?{message:e.detail,type:null,param:null,code:null}:e.error,M),St=e=>"error"in e&&"string"==typeof e.error?X({message:e.error,type:null,param:null,code:null},U):"error"in e&&"object"==typeof e.error?X({message:e.error?.message||"",type:e.error?.type||null,param:e.error?.param||null,code:e.error?.code||null},U):!(!("message"in e)||!e.message)&&X({message:e.message,type:e.type||null,param:null,code:null},U),$t={openai:xt,cohere:Ve,anthropic:Z,"azure-openai":re,anyscale:te,palm:kt,"together-ai":wt,google:ot,"vertex-ai":gt,"perplexity-ai":bt,"mistral-ai":ht,deepinfra:Ye,"stability-ai":Ot,nomic:_t,ollama:Ct,ai21:Y,bedrock:Fe,groq:jt,segmind:{api:{getBaseURL:()=>"https://api.segmind.com/v1",headers:({providerOptions:e})=>({"x-api-key":`${e.apiKey}`}),getEndpoint:({gatewayRequestBody:e})=>`/${e.model}`},imageGenerate:qt,responseTransforms:{imageGenerate:(e,t)=>{if(200!==t&&"error"in e)return X({message:e.error??"",type:null,param:null,code:null},R);if(200!==t&&"html-message"in e)return X({message:e["html-message"]??"",type:null,param:null,code:null},R);if("image"in e){let t=(Array.isArray(e.image)?e.image:[e.image]).map((e=>({b64_json:e})));return{created:`${(new Date).getTime()}`,data:t,provider:R}}return W(e,R)}}},jina:{embed:{model:{param:"model",required:!0,default:"jina-embeddings-v2-base-en"},input:{param:"input",default:""},encoding_format:{param:"encoding_format"}},api:{getBaseURL:()=>"https://api.jina.ai/v1",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>"embed"===e?"/embeddings":""},responseTransforms:{embed:(e,t)=>200!==t&&"detail"in e?X({message:e.detail,type:null,param:null,code:null},D):"data"in e?{object:e.object,data:e.data.map((e=>({object:e.object,index:e.index,embedding:e.embedding}))),provider:D,model:e.model,usage:{prompt_tokens:e.usage?.prompt_tokens,total_tokens:e.usage?.total_tokens}}:W(e,D)}},"fireworks-ai":{complete:{model:{param:"model",required:!0},prompt:{param:"prompt",required:!0},max_tokens:{param:"max_tokens",default:16,min:0},logprobs:{param:"logprobs",min:0,max:5},echo:{param:"echo"},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},top_k:{param:"top_k",min:1,max:128},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},presence_penalty:{param:"presence_penalty",min:-2,max:2},n:{param:"n",default:1,min:1,max:128},stop:{param:"stop"},response_format:{param:"response_format"},stream:{param:"stream",default:!1},context_length_exceeded_behavior:{param:"context_length_exceeded_behavior"},user:{param:"user"}},chatComplete:{model:{param:"model",required:!0},messages:{param:"messages",required:!0,default:[]},tools:{param:"tools"},max_tokens:{param:"max_tokens",default:200,min:1},prompt_truncate_len:{param:"prompt_truncate_len",default:1500},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},top_k:{param:"top_k",min:1,max:128},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},presence_penalty:{param:"presence_penalty",min:-2,max:2},n:{param:"n",default:1,min:1,max:128},stop:{param:"stop"},response_format:{param:"response_format"},stream:{param:"stream",default:!1},context_length_exceeded_behavior:{param:"context_length_exceeded_behavior"},user:{param:"user"}},embed:{model:{param:"model",required:!0,default:"nomic-ai/nomic-embed-text-v1.5"},input:{param:"input",required:!0,transform:e=>Array.isArray(e.input)?e.input:[e.input]},dimensions:{param:"dimensions"}},imageGenerate:{prompt:{param:"text_prompts",required:!0,transform:e=>[{text:e.prompt,weight:1}]},model:{param:"model",required:!0,default:"stable-diffusion-xl-1024-v1-0"},size:[{param:"height",transform:e=>parseInt(e.size.toLowerCase().split("x")[1]),min:512,max:1024,default:1024},{param:"width",transform:e=>parseInt(e.size.toLowerCase().split("x")[0]),min:512,max:1024,default:1024}],cfg_scale:{param:"cfg_scale",default:7},sampler:{param:"sampler"},n:{param:"samples",min:1,max:10,default:1},seed:{param:"seed",min:0,max:4294967295},steps:{param:"steps",min:10,max:150,default:50},safety_check:{param:"safety_check"},lora_adapter_name:{param:"lora_adapter_name"},lora_weight_filename:{param:"lora_weight_filename"}},api:{getBaseURL:()=>"https://api.fireworks.ai/inference/v1",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`,Accept:"application/json"}),getEndpoint:({fn:e,gatewayRequestBody:t})=>{const a=t?.model;switch(e){case"complete":return"/completions";case"chatComplete":return"/chat/completions";case"embed":return"/embeddings";case"imageGenerate":return`/image_generation/${a}`;default:return""}}},responseTransforms:{complete:(e,t)=>200!==t?Tt(e):"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:M,choices:e.choices.map((e=>({index:e.index,logprobs:e.logprobs,text:e.text,finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens,completion_tokens:e.usage?.completion_tokens,total_tokens:e.usage?.total_tokens}}:W(e,M),"stream-complete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:M,choices:[{index:a.choices[0].index??0,text:a.choices[0].text,logprobs:null,finish_reason:a.choices[0].finish_reason}],...a.usage?{usage:a.usage}:{}})}\n\n`},chatComplete:(e,t)=>200!==t?Tt(e):"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:M,choices:e.choices.map((e=>({index:e.index,message:{role:e.message.role,content:e.message.content,tool_calls:e.message.tool_calls},finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens,completion_tokens:e.usage?.completion_tokens,total_tokens:e.usage?.total_tokens}}:W(e,M),"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:M,choices:[{index:a.choices[0].index,delta:a.choices[0].delta,finish_reason:a.choices[0].finish_reason}],...a.usage?{usage:a.usage}:{}})}\n\n`},embed:(e,t)=>"fault"in e&&200!==t?Tt(e):"data"in e?{object:e.object,data:e.data.map((e=>({object:e.object,embedding:e.embedding,index:e.index}))),model:e.model,usage:{prompt_tokens:e.usage.prompt_tokens,total_tokens:e.usage.total_tokens},provider:M}:W(e,M),imageGenerate:(e,t)=>200!=t?Tt(e):e instanceof Array?{created:`${(new Date).getTime()}`,data:e?.map((e=>({b64_json:e.base64,seed:e.seed,finishReason:e.finishReason}))),provider:M}:W(e,M)}},"workers-ai":{complete:{prompt:{param:"prompt",transform:e=>`\n\nHuman: ${e.prompt}\n\nAssistant:`,required:!0},stream:{param:"stream",default:!1},raw:{param:"raw"},max_tokens:{param:"max_tokens"}},chatComplete:{messages:{param:"messages",default:""},stream:{param:"stream",default:!1},raw:{param:"raw"},max_tokens:{param:"max_tokens"}},api:{getBaseURL:({providerOptions:e})=>{const{workersAiAccountId:t}=e;return`https://api.cloudflare.com/client/v4/accounts/${t}/ai/run`},headers:({providerOptions:e})=>{const{apiKey:t}=e;return{Authorization:`Bearer ${t}`}},getEndpoint:({providerOptions:e,fn:t,gatewayRequestBody:a})=>{const{model:o}=a;switch(t){case"complete":case"chatComplete":case"embed":return`/${o}`;default:return""}}},embed:{input:{param:"text",required:!0,transform:e=>Array.isArray(e.input)?e.input:[e.input]}},responseTransforms:{"stream-complete":e=>{let t=e.trim();if(t.startsWith("data: [DONE]"))return"data: [DONE]\n\n";t=t.replace(/^data: /,""),t=t.trim();const a=JSON.parse(t);return`data: ${JSON.stringify({id:"",object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:J,choices:[{text:a.response,index:0,logprobs:null,finish_reason:""}]})}\n\n`},complete:(e,t)=>{if(200!==t){const t=(e=>{if("errors"in e)return X({message:e.errors?.map((e=>`Error ${e.code}:${e.message}`)).join(", "),type:null,param:null,code:null},J)})(e);if(t)return t}return"result"in e?{id:Date.now().toString(),object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:J,choices:[{text:e.result.response,index:0,logprobs:null,finish_reason:""}]}:W(e,J)},chatComplete:(e,t)=>{if(200!==t){const t=(e=>{if("errors"in e)return X({message:e.errors?.map((e=>`Error ${e.code}:${e.message}`)).join(", "),type:null,param:null,code:null},J)})(e);if(t)return t}return"result"in e?{id:Date.now().toString(),object:"chat_completion",created:Math.floor(Date.now()/1e3),model:"",provider:J,choices:[{message:{role:"assistant",content:e.result.response},index:0,logprobs:null,finish_reason:""}]}:W(e,J)},"stream-chatComplete":(e,t)=>{let a=e.trim();if(a.startsWith("data: [DONE]"))return"data: [DONE]\n\n";a=a.replace(/^data: /,""),a=a.trim();const o=JSON.parse(a);return`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:J,choices:[{delta:{content:o.response},index:0,logprobs:null,finish_reason:null}]})}\n\n`},embed:(e,t)=>{if(200!==t){const t=(e=>{if("errors"in e)return X({message:e.errors?.map((e=>`Error ${e.code}:${e.message}`)).join(", "),type:null,param:null,code:null},J)})(e);if(t)return t}return"result"in e?{object:"list",data:e.result.data.map(((e,t)=>({object:"embedding",embedding:e,index:t}))),model:"",usage:{prompt_tokens:-1,total_tokens:-1}}:W(e,J)}}},"reka-ai":{chatComplete:{model:{param:"model_name",required:!0,default:"reka-flash"},messages:{param:"conversation_history",transform:e=>{const t=[];let a;const o=({type:e,text:o,media_url:r})=>{if(r&&t[0].media_url)return;const n={type:e,text:o,media_url:r};if(a===e){const a={type:"human"===e?"model":"human",text:"Placeholder for alternation"};r?t.unshift(a):t.push(a)}r?t.unshift(n):t.push(n),a=e};return e.messages?.forEach((e=>{const t="user"===e.role?"human":"model";Array.isArray(e.content)?e.content.forEach((e=>{o({type:t,text:e.text||"",media_url:e.image_url?.url})})):o({type:t,text:e.content||""})})),"human"!==t[0].type&&t.unshift({type:"human",text:"Placeholder for alternation"}),t}},max_tokens:{param:"request_output_len"},temperature:{param:"temperature"},top_p:{param:"runtime_top_p"},stop:{param:"stop_words",transform:e=>e.stop&&!Array.isArray(e.stop)?[e.stop]:e.stop},seed:{param:"random_seed"},frequency_penalty:{param:"frequency_penalty"},presence_penalty:{param:"presence_penalty"},top_k:{param:"runtime_top_k"},length_penalty:{param:"length_penalty"},retrieval_dataset:{param:"retrieval_dataset"},use_search_engine:{param:"use_search_engine"}},api:{getBaseURL:()=>"https://api.reka.ai",headers:({providerOptions:e})=>({"x-api-key":`${e.apiKey}`}),getEndpoint:({fn:e})=>"chatComplete"===e?"/chat":""},responseTransforms:{chatComplete:(e,t)=>"detail"in e?X({message:JSON.stringify(e.detail),type:null,param:null,code:null},C):"text"in e?{id:crypto.randomUUID(),object:"chat_completion",created:Math.floor(Date.now()/1e3),model:"Unknown",provider:C,choices:[{message:{role:"assistant",content:e.text},index:0,logprobs:null,finish_reason:e.finish_reason}],usage:{prompt_tokens:e.metadata.input_tokens,completion_tokens:e.metadata.generated_tokens,total_tokens:e.metadata.input_tokens+e.metadata.generated_tokens}}:W(e,C)}},moonshot:{chatComplete:{model:{param:"model",required:!0,default:"moonshot-v1-8k"},messages:{param:"messages",default:""},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},stream:{param:"stream",default:!1}},api:{getBaseURL:()=>"https://api.moonshot.cn",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>"chatComplete"===e?"/v1/chat/completions":""},responseTransforms:{chatComplete:(e,t)=>"message"in e&&200!==t?X({message:e.message,type:e.type,param:e.param,code:e.code},P):"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:P,choices:e.choices.map((e=>({index:e.index,message:{role:e.message.role,content:e.message.content},finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens,completion_tokens:e.usage?.completion_tokens,total_tokens:e.usage?.total_tokens}}:W(e,P),"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:P,choices:[{index:a.choices[0].index,delta:a.choices[0].delta,finish_reason:a.choices[0].finish_reason}]})}\n\n`}}},openrouter:{chatComplete:{model:{param:"model",required:!0,default:"openrouter/auto"},messages:{param:"messages",default:""},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},stream:{param:"stream",default:!1}},api:{getBaseURL:()=>"https://openrouter.ai/api",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>"chatComplete"===e?"/v1/chat/completions":""},responseTransforms:{chatComplete:(e,t)=>"message"in e&&200!==t?X({message:e.message,type:e.type,param:e.param,code:e.code},I):"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:I,choices:e.choices.map((e=>({index:e.index,message:{role:e.message.role,content:e.message.content},finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens,completion_tokens:e.usage?.completion_tokens,total_tokens:e.usage?.total_tokens}}:W(e,I),"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;t.includes("OPENROUTER PROCESSING")&&(t=JSON.stringify({id:`${Date.now()}`,model:"",object:"chat.completion.chunk",created:Date.now(),choices:[{index:0,delta:{role:"assistant",content:""},finish_reason:null}]}));const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:I,choices:[{index:a.choices[0].index,delta:a.choices[0].delta,finish_reason:a.choices[0].finish_reason}]})}\n\n`}}},lingyi:{chatComplete:{model:{param:"model",required:!0,default:"yi-34b-chat-0205"},messages:{param:"messages",default:""},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},stream:{param:"stream",default:!1}},api:{getBaseURL:()=>"https://api.lingyiwanwu.com",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>"chatComplete"===e?"/v1/chat/completions":""},responseTransforms:{chatComplete:(e,t)=>"message"in e&&200!==t?X({message:e.message,type:e.type,param:e.param,code:e.code},z):"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:z,choices:e.choices.map((e=>({index:e.index,message:{role:e.message.role,content:e.message.content},finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens,completion_tokens:e.usage?.completion_tokens,total_tokens:e.usage?.total_tokens}}:W(e,z),"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:z,choices:[{index:a.choices[0].index,delta:a.choices[0].delta,finish_reason:a.choices[0].finish_reason}]})}\n\n`}}},zhipu:{chatComplete:{model:{param:"model",required:!0,default:"glm-3-turbo"},messages:{param:"messages",default:""},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},stream:{param:"stream",default:!1}},embed:{model:{param:"model",required:!0,default:"embedding-2"},input:{param:"input",required:!0}},api:{getBaseURL:()=>"https://open.bigmodel.cn/api/paas/v4",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>{switch(e){case"chatComplete":return"/chat/completions";case"embed":return"/embeddings";default:return""}}},responseTransforms:{chatComplete:(e,t)=>"message"in e&&200!==t?X({message:e.message,type:e.type,param:e.param,code:e.code},B):"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:B,choices:e.choices.map((e=>({index:e.index,message:{role:e.message.role,content:e.message.content},finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens,completion_tokens:e.usage?.completion_tokens,total_tokens:e.usage?.total_tokens}}:W(e,B),"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:B,choices:[{index:a.choices[0].index,delta:a.choices[0].delta,finish_reason:a.choices[0].finish_reason}]})}\n\n`},embed:(e,t)=>200!==t&&"error"in e?X({message:e.error.message,type:e.error.type,param:e.error.param,code:e.error.code},B):e}},"novita-ai":{complete:{model:{param:"model",required:!0,default:"lzlv_70b"},prompt:{param:"prompt",required:!0,default:""},max_tokens:{param:"max_tokens",required:!0,default:128,min:1},stop:{param:"stop"},temperature:{param:"temperature"},top_p:{param:"top_p"},top_k:{param:"top_k"},frequency_penalty:{param:"repetition_penalty"},stream:{param:"stream",default:!1},logprobs:{param:"logprobs"}},chatComplete:{model:{param:"model",required:!0,default:"lzlv_70b"},messages:{param:"messages",required:!0,default:""},max_tokens:{param:"max_tokens",required:!0,default:128,min:1},stop:{param:"stop"},temperature:{param:"temperature"},top_p:{param:"top_p"},n:{param:"n"},top_k:{param:"top_k"},presence_penalty:{param:"presence_penalty",min:-2,max:2},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},stream:{param:"stream",default:!1},logprobs:{param:"logprobs"},tools:{param:"tools"},tool_choice:{param:"tool_choice"},response_format:{param:"response_format"}},api:{getBaseURL:()=>"https://api.novita.ai/v3/openai",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>{switch(e){case"complete":return"/v1/completions";case"chatComplete":return"/v1/chat/completions";default:return""}}},responseTransforms:{"stream-complete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:U,choices:[{text:a.choices[0]?.text,index:0,finish_reason:""}]})}\n\n`},complete:(e,t)=>{if(200!==t){const t=St(e);if(t)return t}return"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:U,choices:e.choices.map((e=>({text:e.text,index:e.index||0,logprobs:null,finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens,completion_tokens:e.usage?.completion_tokens,total_tokens:e.usage?.total_tokens}}:W(e,U)},chatComplete:(e,t)=>{if(200!==t){const t=St(e);if(t)return t}return"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:U,choices:e.choices.map((e=>({message:{role:"assistant",content:e.message.content,tool_calls:e.message.tool_calls?e.message.tool_calls.map((e=>({id:e.id,type:e.type,function:e.function}))):null},index:0,logprobs:null,finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens,completion_tokens:e.usage?.completion_tokens,total_tokens:e.usage?.total_tokens}}:W(e,U)},"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:Math.floor(Date.now()/1e3),model:"",provider:U,choices:[{delta:{content:a.choices[0]?.delta.content},index:a.choices[0]?.index||0,finish_reason:""}]})}\n\n`}}},monsterapi:{api:{getBaseURL:()=>"https://llm.monsterapi.ai/v1",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>"chatComplete"===e?"/generate":""},chatComplete:{top_k:{param:"top_k",min:1,max:20},top_p:{param:"top_p",min:0,max:1},temperature:{param:"temperature",min:0,max:1},max_length:{param:"max_length",min:1,max:2048},repetition_penalty:{param:"repetition_penalty",min:0},beam_size:{param:"beam_size",min:1},model:{param:"model",required:!0,default:"mistralai/Mistral-7B-Instruct-v0.2"},messages:{param:"messages",required:!0,default:[]}},responseTransforms:{chatComplete:(e,t)=>"error"in e?X({message:e.error.message,type:e.error.type,param:null,code:e.error.code.toString()},L):"response"in e?{id:Date.now().toString(),object:"chat.completion",created:Math.floor(Date.now()/1e3),model:e?.model,choices:[{message:{role:"assistant",content:e.response.text.join("\n")},index:0,logprobs:null,finish_reason:"completed"}],usage:{prompt_tokens:e.response.token_counts.input,completion_tokens:e.response.token_counts.output,total_tokens:e.response.token_counts.input+e.response.token_counts.output},provider:L}:W(e,L)}},predibase:{chatComplete:{model:{param:"model",required:!1,default:"",transform:e=>F(e.model,":").after},messages:{param:"messages",required:!0,default:[]},max_tokens:{param:"max_tokens",required:!1,default:4096,min:0},temperature:{param:"temperature",required:!1,default:.1,min:0,max:1},top_p:{param:"top_p",required:!1,default:1,min:0,max:1},response_format:{param:"response_format",required:!1},stream:{param:"stream",required:!1,default:!1},n:{param:"n",required:!1,default:1,max:1,min:1},stop:{param:"stop",required:!1},top_k:{param:"top_k",required:!1,default:-1},best_of:{param:"best_of",required:!1}},api:{getBaseURL:()=>"https://serving.app.predibase.com",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`,Accept:"application/json"}),getEndpoint:({fn:e,gatewayRequestBody:t})=>{const a=t?.user,o=t?.model,r=F(`${o}`,":").before;return"chatComplete"===e?`/${a}/deployments/v2/llms/${r}/v1/chat/completions`:""}},responseTransforms:{chatComplete:(e,t)=>"error"in e&&200!==t?X({message:e.error.message,type:e.error.type,param:null,code:e.error.code?.toString()||null},K):"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:K,choices:e.choices.map((e=>({index:e.index,message:e.message,logprobs:e.logprobs,finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens||0,completion_tokens:e.usage?.completion_tokens||0,total_tokens:e.usage?.total_tokens||0}}:W(e,K),"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data:\s*/,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return"error"in a?`data: ${JSON.stringify({id:null,object:null,created:null,model:null,provider:K,choices:[{index:0,delta:{role:a.error_type,content:a.error},finish_reason:"error"}]})}\n\n`:`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:K,choices:[{index:a.choices[0].index,delta:a.choices[0].delta,finish_reason:a.choices[0].finish_reason}],...a.usage?{usage:a.usage}:{}})}\n\n`}}}};function Nt(e,t,a){const o=t.split(".");let r=e;for(let e=0;e<o.length-1;e++)r[o[e]]||(r[o[e]]={}),r=r[o[e]];r[o[o.length-1]]=a}const Et=(e,t,a)=>{let o=$t[e];if(o=o.getConfig?o.getConfig(t)[a]:o[a],!o)throw new Error("Unsupported provider");const r={};for(const e in o){let a=o[e];Array.isArray(a)||(a=[a]);for(const o of a)if(e in t){let a=t[e];o.transform&&(a=o.transform(t)),"portkey-default"===a&&o&&void 0!==o.default&&(a=o.default),"number"==typeof a&&o&&void 0!==o.min&&a<o.min?a=o.min:"number"==typeof a&&o&&void 0!==o.max&&a>o.max&&(a=o.max),Nt(r,o?.param,a)}else o&&o.required&&void 0!==o.default&&Nt(r,o.param,o.default)}return r},At=(e,t)=>{let a="\n\n";return e===y&&t.endsWith("/complete")&&(a="\r\n\r\n"),e===h&&(a="\n"),e===v&&(a="\r\n"),e===w&&-1===t.indexOf("/publishers/anthropic")&&(a="\r\n\r\n"),e===O&&(a="\r\n\r\n"),e===q&&(a="\r\n\r\n"),a};function Rt(e,t=[]){return"object"!=typeof e||null===e?e:Array.isArray(e)?e.map((e=>Rt(e,t))):Object.keys(e).reduce(((a,o)=>{const r=e[o],n=o.replace(/(_\w)/g,(e=>e[1].toUpperCase()));const s=t.includes(o);return a[n]="object"!=typeof r||s?r:Rt(r,t),a}),{})}const Dt=async(e,t,a,o,r)=>{let n,i,p;try{await s((async(s,p)=>{try{const a=r?await async function(e,t,a){const o={...t,signal:AbortSignal.timeout(a)};let r;try{r=await fetch(e,o)}catch(e){if("TimeoutError"!==e.name)throw e;r=new Response(JSON.stringify({error:{message:`Request exceeded the timeout sent in the request: ${a}ms`,type:"timeout_error",param:null,code:null}}),{headers:{"content-type":"application/json"},status:408})}return r}(e,t,r):await fetch(e,t);if(o.includes(a.status)){const e=new Error(await a.text());throw e.status=a.status,e.headers=Object.fromEntries(a.headers),e}if(!(a.status>=200&&a.status<=204)){const e=new Error(await a.clone().text());return e.status=a.status,e.headers=Object.fromEntries(a.headers),void s(e)}console.log(`Returned in Retry Attempt ${p}. Status:`,a.ok,a.status),i=a}catch(e){if(n=e,p>=a+1)return void s(e);throw e}}),{retries:a,onRetry:(e,t)=>{p=t,console.warn(`Failed in Retry attempt ${t}. Error: ${e}`)},randomize:!1})}catch(e){i=new Response(e.message,{status:e.status,headers:e.headers}),console.warn(`Tried ${p} time(s) but failed. Error: ${JSON.stringify(e)}`)}return[i,p]};function Mt(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}function Jt(e){const t=new TextDecoder,a=Mt(e,0),o=12+Mt(e,4),r=a-o-4,n=e.slice(o,o+r);return t.decode(n)}function Pt(e,t){const a=new Uint8Array(e.length+t.length);return a.set(e,0),a.set(t,e.length),a}async function It(e,t,a,o){const r=At(t,o),n=`${t}-${Date.now().toString()}`;if(!e.body)throw new Error("Response format is invalid. Body not found");const{readable:s,writable:i}=new TransformStream,p=i.getWriter(),m=e.body.getReader(),c=t===_,l=new TextEncoder;return t===E?(async()=>{for await(const e of async function*(e,t,a){let o=new Uint8Array,r=0;const n={};for(;;){const{done:i,value:p}=await e.read();if(i){if(o.length)for(r=Mt(o,0);o.length>=r&&0!==o.length;){const e=o.subarray(0,r);o=o.subarray(r),r=Mt(o,0);const i=Buffer.from(JSON.parse(Jt(e)).bytes,"base64").toString();if(t){const e=t(i,a,n);if(Array.isArray(e))for(var s of e)yield s;else yield e}else yield e}break}for(0===r&&(r=Mt(p,0)),o=Pt(o,p);o.length>=r&&0!==o.length;){const e=o.subarray(0,r);o=o.subarray(r),r=Mt(o,0);const i=Buffer.from(JSON.parse(Jt(e)).bytes,"base64").toString();if(t){const e=t(i,a,n);if(Array.isArray(e))for(var s of e)yield s;else yield e}else yield e}}}(m,a,n))await p.write(l.encode(e));p.close()})():(async()=>{for await(const e of async function*(e,t,a,o,r){let n="",s=new TextDecoder,i=!0;const p={};for(;;){const{done:m,value:c}=await e.read();if(m){n.length>0&&(a?yield a(n,r,p):yield n);break}for(n+=s.decode(c,{stream:!0});n.split(t).length>1;){let e=n.split(t),s=e.pop()??"";for(let n of e)if(n.length>0)if(i?(i=!1,await new Promise((e=>setTimeout(e,25)))):o&&await new Promise((e=>setTimeout(e,1))),a){const e=a(n,r,p);void 0!==e&&(yield e)}else yield n+t;n=s}}}(m,r,a,c,n))await p.write(l.encode(e));p.close()})(),[v,h,E].includes(t)&&a?new Response(s,{...e,headers:new Headers({...Object.fromEntries(e.headers),"content-type":"text/event-stream"})}):new Response(s,e)}function zt(e,t,a,o,r){let n={};Object.keys(e).forEach((t=>{n[t.toLowerCase()]=e[t]}));const s={};o.forEach((e=>{const t=e.toLowerCase();r[t]&&(s[t]=r[t])})),n={"content-type":"application/json",...n,...s};let i={method:a,headers:n};if("GET"===a&&i.headers){delete i.headers["content-type"]}return i}function Bt(e){let t=(e=e.map((e=>({...e,weight:e.weight??1})))).reduce(((e,t)=>e+t.weight),0),a=Math.random()*t;for(let[t,o]of e.entries()){if(a<o.weight)return{...o,index:t};a-=o.weight}throw new Error("No provider selected, please check the weights")}const Ut=e=>{let t,a=null;const o=Rt(e,["override_params","params","metadata"]);return"provider"in o?(a=[{provider:o.provider,virtualKey:o.virtualKey,apiKey:o.apiKey,cache:o.cache,retry:o.retry,customHost:o.customHost}],o.resourceName&&(a[0].resourceName=o.resourceName),o.deploymentId&&(a[0].deploymentId=o.deploymentId),o.apiVersion&&(a[0].apiVersion=o.apiVersion),o.apiVersion&&(a[0].vertexProjectId=o.vertexProjectId),o.apiVersion&&(a[0].vertexRegion=o.vertexRegion),o.workersAiAccountId&&(a[0].workersAiAccountId=o.workersAiAccountId),t="single"):(t=o.strategy&&o.strategy.mode?o.strategy.mode:o.mode,a=function(e,t){switch(t.targets&&(t.options=t.targets),t.options&&t.options.forEach((e=>{t.cache&&!e.cache&&(e.cache=t.cache),t.retry&&!e.retry&&(e.retry=t.retry)})),e){case"single":return[t.options[0]];case"loadbalance":return[Bt(t.options)];case"fallback":return t.options;default:return null}}(t,o)),a};async function Lt(e,t,a,o,r,n,s="POST"){const p={...a,...t?.overrideParams||{}},m=!!p.stream,l=t.provider??"",u=$t[l].api,f=o[c.CUSTOM_HOST]||t.customHost||""||u.getBaseURL({providerOptions:t}),g=u.getEndpoint({providerOptions:t,fn:r,gatewayRequestBody:p}),h=g?`${f}${g}`:t.urlToFetch,_=zt(await u.headers({providerOptions:t,fn:r,transformedRequestBody:p,transformedRequestUrl:h}),0,s,[],o);let y,x;"POST"===s&&(_.body=JSON.stringify(p)),t.retry&&"object"==typeof t.retry?t.retry={attempts:t.retry?.attempts??0,onStatusCodes:t.retry?.onStatusCodes??d}:"number"==typeof t.retry?t.retry={attempts:t.retry,onStatusCodes:d}:t.retry={attempts:1,onStatusCodes:[]};const k=e.get("getFromCache"),b=e.get("cacheIdentifier"),v=e.get("requestOptions")??[];let w,O,C,j,q="DISABLED";if(o[c.CACHE]?C=o[c.CACHE]:t?.cache&&"object"==typeof t.cache&&t.cache.mode?(C=t.cache.mode,j=t.cache.maxAge):t?.cache&&"string"==typeof t.cache&&(C=t.cache),k&&C&&([w,q,O]=await k(i(e),{...o,..._.headers},p,h,b,C,j),w))return y=await Gt(new Response(w,{headers:{"content-type":"application/json"}}),!1,l,void 0,h,!1,p),e.set("requestOptions",[...v,{providerOptions:{...t,requestURL:h,rubeusURL:r},requestParams:p,response:y.clone(),cacheStatus:q,lastUsedOptionIndex:n,cacheKey:O,cacheMode:C,cacheMaxAge:j}]),Xt(y,n,p,q,0,o[c.TRACE_ID]??""),y;[y,x]=await Dt(h,_,t.retry.attempts,t.retry.onStatusCodes,null);const T=await Gt(y,m,l,void 0,h,!1,p);if(Xt(T,n,p,q,x??0,o[c.TRACE_ID]??""),e.set("requestOptions",[...v,{providerOptions:{...t,requestURL:h,rubeusURL:r},requestParams:p,response:T.clone(),cacheStatus:q,lastUsedOptionIndex:n,cacheKey:O,cacheMode:C}]),!y.ok){const e=new Error(await T.text());throw e.status=T.status,e}return T}async function Kt(e,t,a,o,r,n){const s={...a,...t?.overrideParams||{}},p=!!s.stream,m=t.provider??"",l=$t[m].api,u=Et(m,s,r),f=o[c.FORWARD_HEADERS]?.split(",").map((e=>e.trim()))||t.forwardHeaders||[],g=o[c.CUSTOM_HOST]||t.customHost||"",h=Number(o[c.REQUEST_TIMEOUT])||t.requestTimeout||null,_=`${g||l.getBaseURL({providerOptions:t})}${l.getEndpoint({providerOptions:t,fn:r,gatewayRequestBody:s})}`,y=zt(await l.headers({providerOptions:t,fn:r,transformedRequestBody:u,transformedRequestUrl:_}),0,"POST",f,o);let x,k;y.body=JSON.stringify(u),t.retry={attempts:t.retry?.attempts??0,onStatusCodes:t.retry?.onStatusCodes??d};const[b,v,w,O]=[e.get("getFromCache"),e.get("cacheIdentifier"),e.get("requestOptions")??[],e.get("preRequestValidator")];let C,j,q,T,S="DISABLED";if("object"==typeof t.cache&&t.cache?.mode?(q=t.cache.mode,T=t.cache.maxAge):"string"==typeof t.cache&&(q=t.cache),b&&q&&([C,S,j]=await b(i(e),{...o,...y.headers},u,r,v,q,T),C))return x=await Gt(new Response(C,{headers:{"content-type":"application/json"}}),p,m,r,_,!0,s),e.set("requestOptions",[...w,{providerOptions:{...t,requestURL:_,rubeusURL:r},requestParams:u,response:x.clone(),cacheStatus:S,lastUsedOptionIndex:n,cacheKey:j,cacheMode:q}]),Xt(x,n,s,S,0,o[c.TRACE_ID]??""),x;x=O?O(t,o):void 0,x||([x,k]=await Dt(_,y,t.retry.attempts,t.retry.onStatusCodes,h));const $=await Gt(x,p,m,r,_,!1,s);if(Xt($,n,s,S,k??0,o[c.TRACE_ID]??""),e.set("requestOptions",[...w,{providerOptions:{...t,requestURL:_,rubeusURL:r},requestParams:u,response:$.clone(),cacheStatus:S,lastUsedOptionIndex:n,cacheKey:j,cacheMode:q,cacheMaxAge:T}]),!x.ok){const e=new Error(await $.clone().text());throw e.status=$.status,e.response=$,e}return $}async function Ht(e,t,a,o,r,n="POST"){let s=[];for(let[i,p]of t.entries())try{const t=isNaN(Number(p.index))?null:Number(p.index);return"proxy"===r?await Lt(e,p,a,o,r,t??i,n):await Kt(e,p,a,o,r,t??i)}catch(e){s.push({provider:p.provider,errorObj:e.message,status:e.status})}throw new Error(JSON.stringify(s))}function Gt(e,t,a,o,r,n=!1,s){let i;const p=e.headers?.get("content-type"),m=$t[a];let c=$t[a]?.responseTransforms;return m.getConfig&&(c=m.getConfig(s).responseTransforms),o&&t&&200===e.status?i=c?.[`stream-${o}`]:o&&(i=c?.[o]),o&&t&&n?i="chatComplete"===o?oe:yt:o&&!t&&n&&(i=void 0),t&&200===e.status&&n&&i?async function(e,t,a){const{readable:o,writable:r}=new TransformStream,n=r.getWriter(),s=new TextEncoder,i=a(await e.clone().json(),t);return(async()=>{for(const e of i)await n.write(s.encode(e));n.close()})(),new Response(o,{headers:new Headers({...Object.fromEntries(e.headers),"content-type":G.EVENT_STREAM})})}(e,a,i):t&&200===e.status?It(e,a,i,r):p?.startsWith(G.GENERIC_AUDIO_PATTERN)||p===G.APPLICATION_OCTET_STREAM||p?.startsWith(G.GENERIC_IMAGE_PATTERN)?async function(e){return new Response(e.body,e)}(e):p?.startsWith(G.PLAIN_TEXT)||p?.startsWith(G.HTML)?async function(e,t){const a=await e.text();if(t){const o=t({"html-message":a},e.status);return new Response(JSON.stringify(o),{...e,status:e.status,headers:new Headers({...Object.fromEntries(e.headers),"content-type":"application/json"})})}return new Response(a,e)}(e,i):async function(e,t){if([u,f].includes(e.status))return e;let a=await e.json();return t&&(a=t(a,e.status,e.headers)),new Response(JSON.stringify(a),e)}(e,i)}async function Wt(e,t,a,o,r,n,s,i={}){let p={...t},m=s;const c=p.strategy?.mode,l={overrideParams:{...i.overrideParams,...p.overrideParams},retry:p.retry?{...p.retry}:{...i.retry},cache:p.cache?{...p.cache}:{...i.cache},requestTimeout:null};let d;switch(p.forwardHeaders?l.forwardHeaders=[...p.forwardHeaders]:i.forwardHeaders&&(l.forwardHeaders=[...i.forwardHeaders],p.forwardHeaders=[...i.forwardHeaders]),p.customHost?l.customHost=p.customHost:i.customHost&&(l.customHost=i.customHost,p.customHost=i.customHost),p.requestTimeout?l.requestTimeout=p.requestTimeout:i.requestTimeout&&(l.requestTimeout=i.requestTimeout,p.requestTimeout=i.requestTimeout),p.overrideParams={...l.overrideParams},p.retry={...l.retry},p.cache={...l.cache},c){case"fallback":for(let[t,s]of p.targets.entries())if(d=await Wt(e,s,a,o,r,n,`${m}.targets[${t}]`,l),d?.ok||p.strategy.onStatusCodes&&!p.strategy.onStatusCodes.includes(d?.status))break;break;case"loadbalance":p.targets.forEach((e=>{void 0===e.weight&&(e.weight=1)}));let t=p.targets.reduce(((e,t)=>e+t.weight),0),s=Math.random()*t;for(let[t,i]of p.targets.entries()){if(s<i.weight){m+=`.targets[${t}]`,d=await Wt(e,i,a,o,r,n,m,l);break}s-=i.weight}break;case"single":d=await Wt(e,p.targets[0],a,o,r,n,`${m}.targets[0]`,l);break;default:try{d=await Kt(e,p,a,o,r,m)}catch(e){d=e.response}}return d}function Xt(e,t,a,o,r,n){e.headers.append(l.LAST_USED_OPTION_INDEX,t.toString()),e.headers.append(l.CACHE_STATUS,o),e.headers.append(l.TRACE_ID,n),e.headers.append(l.RETRY_ATTEMPT_COUNT,r.toString()),e.headers.delete("content-encoding")}function Ft(e){const t={resourceName:e[`x-${m}-azure-resource-name`],deploymentId:e[`x-${m}-azure-deployment-id`],apiVersion:e[`x-${m}-azure-api-version`]},a={awsAccessKeyId:e[`x-${m}-aws-access-key-id`],awsSecretAccessKey:e[`x-${m}-aws-secret-access-key`],awsSessionToken:e[`x-${m}-aws-session-token`],awsRegion:e[`x-${m}-aws-region`]},o={workersAiAccountId:e[`x-${m}-workers-ai-account-id`]},r={openaiOrganization:e[`x-${m}-openai-organization`],openaiProject:e[`x-${m}-openai-project`]},n={vertexProjectId:e[`x-${m}-vertex-project-id`],vertexRegion:e[`x-${m}-vertex-region`]};let s=e[`x-${m}-vertex-service-account-json`];if(s)try{n.vertexServiceAccountJson=JSON.parse(s)}catch(e){n.vertexServiceAccountJson=null}if(e[`x-${m}-config`]){let s=JSON.parse(e[`x-${m}-config`]);return s.provider||s.targets||(s.provider=e[`x-${m}-provider`],s.api_key=e.authorization?.replace("Bearer ",""),s.provider===_&&(s={...s,...t}),s.provider===E&&(s={...s,...a}),s.provider===J&&(s={...s,...o}),s.provider===g&&(s={...s,...r}),s.provider===w&&(s={...s,...n})),Rt(s,["override_params","params","vertex_service_account_json"])}return{provider:e[`x-${m}-provider`],apiKey:e.authorization?.replace("Bearer ",""),...e[`x-${m}-provider`]===_&&t,...e[`x-${m}-provider`]===E&&a,...e[`x-${m}-provider`]===J&&o,...e[`x-${m}-provider`]===w&&n,...e[`x-${m}-provider`]===g&&r}}function Vt(e,t){let a={};const o=`x-${m}-`,r=[...t];return e["content-type"]?.split(";")[0]===G.MULTIPART_FORM_DATA&&r.push("content-type"),r.push("content-length"),Object.keys(e).forEach((t=>{r.includes(t)||t.startsWith(o)||(a[t]=e[t])})),a}async function Yt(e){try{const s=Object.fromEntries(e.req.raw.headers),p=s["content-type"]?.split(";")[0],[l,u]=await async function(e,t){let a,o={},r="";if(t==G.APPLICATION_JSON){if(["GET","DELETE"].includes(e.method))return[o,a];r=await e.text(),o=JSON.parse(r)}else t==G.MULTIPART_FORM_DATA&&(a=await e.formData(),a.forEach((function(e,t){o[t]=e})));return[o,a]}(e.req.raw,p),f={proxyProvider:(r=s[c.MODE],n=s[`x-${m}-provider`],r?.split(" ")[1]??n),reqBody:l,requestFormData:u,customHeadersToAvoid:i(e).CUSTOM_HEADERS_TO_IGNORE??[],proxyPath:e.req.url.indexOf("/v1/proxy")>-1?"/v1/proxy":"/v1"};let g=null;s[`x-${m}-config`]&&(g=JSON.parse(s[`x-${m}-config`]),g&&"provider"in g&&(f.proxyProvider=g.provider));const h=s[c.CUSTOM_HOST]||g?.customHost||"";let x=function(e,t,a,o){let r=new URL(e),n=r.pathname;const s=r.search;if(n=n.replace(a,""),o)return`${o}${n}${s}`;const i=$t[t].api.getBaseURL({providerOptions:{}});if(t===_)return`https:/${n}${s}`;if(t===$)return`https:/${n}`;let p=`${i}${n}${s}`;return t===y&&(p=p.replace("/v1/v1/","/v1/")),p}(e.req.url,f.proxyProvider,f.proxyPath,h);if(f.isStreamingMode=(t=f.reqBody,a=f.proxyProvider,o=x,a===v&&o.indexOf("stream")>-1||t.stream),g&&("options"in g&&g.options||"targets"in g&&g.targets||"provider"in g&&g.provider)){let t=Ut(g);if(!t)return new Response(JSON.stringify({status:"failure",message:"Could not find a provider option."}),{status:400,headers:{"content-type":"application/json"}});t=t.map((e=>({...e,urlToFetch:x})));try{return await Ht(e,t,f.reqBody,s,"proxy")}catch(e){const t=JSON.parse(e.message);return new Response(t[t.length-1].errorObj,{status:t[t.length-1].status,headers:{"content-type":"application/json"}})}}g&&(g=Rt(g,["override_params","params","metadata"]));let k={headers:Vt(s,f.customHeadersToAvoid),method:e.req.method,body:p===G.MULTIPART_FORM_DATA?f.requestFormData:JSON.stringify(f.reqBody)},b=0,w=d;s[c.RETRIES]?b=parseInt(s[c.RETRIES]):g?.retry&&"object"==typeof g.retry&&(b=g.retry?.attempts??1,w=g.retry?.onStatusCodes??d),b=Math.min(b,5);const O=e.get("getFromCache"),C=e.get("cacheIdentifier");let j,q,T,S="DISABLED",N=s[c.CACHE];if(g?.cache&&"object"==typeof g.cache&&g.cache.mode?(N=g.cache.mode,T=g.cache.maxAge):g?.cache&&"string"==typeof g.cache&&(N=g.cache),O&&N&&([j,S,q]=await O(i(e),{...s,...k.headers},f.reqBody,x,C,N),j)){const t=await Gt(new Response(j,{headers:{"content-type":"application/json"}}),!1,f.proxyProvider,void 0,x,!1,f.reqBody);return e.set("requestOptions",[{providerOptions:{...f.reqBody,provider:f.proxyProvider,requestURL:x,rubeusURL:"proxy"},requestParams:f.reqBody,response:t.clone(),cacheStatus:S,cacheKey:q,cacheMode:N,cacheMaxAge:T}]),Xt(t,0,f.reqBody,S,0,s[c.TRACE_ID]??""),t}let[E,A]=await Dt(x,k,b,w,null);const R=await Gt(E,f.isStreamingMode,f.proxyProvider,void 0,x,!1,f.reqBody);return Xt(R,0,f.reqBody,S,A??0,s[c.TRACE_ID]??""),e.set("requestOptions",[{providerOptions:{...f.reqBody,provider:f.proxyProvider,requestURL:x,rubeusURL:"proxy"},requestParams:f.reqBody,response:R.clone(),cacheStatus:S,cacheKey:q,cacheMode:N,cacheMaxAge:T}]),R}catch(e){return console.log("proxy error",e.message),new Response(JSON.stringify({status:"failure",message:"Something went wrong"}),{status:500,headers:{"content-type":"application/json"}})}var t,a,o,r,n}function Qt(e,t){let a={};const o=`x-${m}-`,r=[...t];return r.push("content-length"),Object.keys(e).forEach((t=>{r.includes(t)||t.startsWith(o)||(a[t]=e[t])})),a["accept-encoding"]="gzip, deflate",a}async function Zt(e){try{const o=Object.fromEntries(e.req.raw.headers);delete o["content-type"];const r={proxyProvider:(t=o[c.MODE],a=o[c.PROVIDER],t?.split(" ")[1]??a),customHeadersToAvoid:i(e).CUSTOM_HEADERS_TO_IGNORE??[],reqBody:{},proxyPath:e.req.url.indexOf("/v1/proxy")>-1?"/v1/proxy":"/v1"},n=o[c.CUSTOM_HOST]||"";let s=function(e,t,a,o){let r=new URL(e),n=r.pathname;const s=r.search;if(n=n.replace(a,""),o)return`${o}${n}${s}`;const i=$t[t].api.getBaseURL({providerOptions:{}});if(t===_)return`https:/${n}${s}`;let p=`${i}${n}${s}`;return t===y&&(p=p.replace("/v1/v1/","/v1/")),p}(e.req.url,r.proxyProvider,r.proxyPath,n),p={headers:Qt(o,r.customHeadersToAvoid),method:e.req.method},m=Math.min(parseInt(o[c.RETRIES])||1,5),[l,u]=await Dt(s,p,m,d,null);const f=await Gt(l,r.isStreamingMode,r.proxyProvider,void 0,s,!1,r.reqBody);return Xt(f,0,r.reqBody,"DISABLED",u??0,o[c.TRACE_ID]??""),e.set("requestOptions",[{providerOptions:{...r.reqBody,provider:r.proxyProvider,requestURL:s,rubeusURL:"proxy"},requestParams:r.reqBody,response:f.clone(),cacheStatus:"DISABLED",cacheKey:void 0}]),f}catch(e){return console.log("proxyGet error",e.message),new Response(JSON.stringify({status:"failure",message:"Something went wrong"}),{status:500,headers:{"content-type":"application/json"}})}var t,a}async function ea(e){try{let t=await e.req.json(),a=Object.fromEntries(e.req.raw.headers);const o=Ft(a);return await Wt(e,o??{},t,a,"chatComplete","POST","config")}catch(e){return console.log("chatCompletion error",e.message),new Response(JSON.stringify({status:"failure",message:"Something went wrong"}),{status:500,headers:{"content-type":"application/json"}})}}async function ta(e){try{let t=await e.req.json(),a=Object.fromEntries(e.req.raw.headers);const o=Ft(a);return await Wt(e,o,t,a,"complete","POST","config")}catch(e){return console.log("completion error",e.message),new Response(JSON.stringify({status:"failure",message:"Something went wrong"}),{status:500,headers:{"content-type":"application/json"}})}}const aa=p.object({strategy:p.object({mode:p.string().refine((e=>["single","loadbalance","fallback"].includes(e)),{message:"Invalid 'mode' value. Must be one of: single, loadbalance, fallback"}),on_status_codes:p.array(p.number()).optional()}).optional(),provider:p.string().refine((e=>H.includes(e)),{message:`Invalid 'provider' value. Must be one of: ${H.join(", ")}`}).optional(),api_key:p.string().optional(),aws_secret_access_key:p.string().optional(),aws_access_key_id:p.string().optional(),aws_session_token:p.string().optional(),aws_region:p.string().optional(),cache:p.object({mode:p.string().refine((e=>["simple","semantic"].includes(e)),{message:"Invalid 'cache.mode' value. Must be one of: simple, semantic"}),max_age:p.number().optional()}).refine((e=>void 0!==e.mode),{message:"'cache.mode' must be defined"}).optional(),retry:p.object({attempts:p.number(),on_status_codes:p.array(p.number()).optional()}).refine((e=>void 0!==e.attempts),{message:"'retry.attempts' must be defined"}).optional(),weight:p.number().optional(),on_status_codes:p.array(p.number()).optional(),targets:p.array(p.lazy((()=>aa))).optional(),request_timeout:p.number().optional(),custom_host:p.string().optional(),forward_headers:p.array(p.string()).optional(),vertex_project_id:p.string().optional(),vertex_region:p.string().optional(),vertex_service_account_json:p.object({}).catchall(p.string()).optional(),openai_project:p.string().optional(),openai_organization:p.string().optional()}).refine((e=>{const t=void 0!==e.provider&&void 0!==e.api_key,a=void 0!==e.strategy&&void 0!==e.targets,o=e.provider===$,r=e.provider===w&&e.vertex_region&&(e.vertex_service_account_json||e.vertex_project_id),n=e.aws_access_key_id&&e.aws_secret_access_key;return t||a||e.cache||e.retry||e.request_timeout||o||n||r}),{message:"Invalid configuration. It must have either 'provider' and 'api_key', or 'strategy' and 'targets', or 'cache', or 'retry', or 'request_timeout'"}).refine((e=>{const t=e.custom_host;return!(t&&t.indexOf("api.portkey")>-1)}),{message:"Invalid custom host"}).refine((e=>{const t=e.provider===w,a=e.vertex_project_id&&e.vertex_region||e.vertex_region&&e.vertex_service_account_json;return!(t&&!a)}),{message:`Invalid configuration. ('vertex_project_id' and 'vertex_region') or ('vertex_service_account_json' and 'vertex_region') are required for '${w}' provider. Example: { 'provider': 'vertex-ai', 'vertex_project_id': 'my-project-id', 'vertex_region': 'us-central1', api_key: 'ya29...' }`}),oa=(e,t)=>{const a=Object.fromEntries(e.req.raw.headers);if(a["content-type"]&&![G.APPLICATION_JSON,G.MULTIPART_FORM_DATA].includes(a["content-type"].split(";")[0]))return new Response(JSON.stringify({status:"failure",message:"Invalid content type passed"}),{status:400,headers:{"content-type":"application/json"}});if(!a[`x-${m}-config`]&&!a[`x-${m}-provider`])return new Response(JSON.stringify({status:"failure",message:`Either x-${m}-config or x-${m}-provider header is required`}),{status:400,headers:{"content-type":"application/json"}});if(a[`x-${m}-provider`]&&!H.includes(a[`x-${m}-provider`]))return new Response(JSON.stringify({status:"failure",message:"Invalid provider passed"}),{status:400,headers:{"content-type":"application/json"}});const o=a[`x-${m}-custom-host`];if(o&&o.indexOf("api.portkey")>-1)return new Response(JSON.stringify({status:"failure",message:"Invalid custom host"}),{status:400,headers:{"content-type":"application/json"}});if(a[`x-${m}-config`])try{const e=JSON.parse(a[`x-${m}-config`]);if(!a[`x-${m}-provider`]&&!e.provider&&!e.targets)return new Response(JSON.stringify({status:"failure",message:`Either x-${m}-provider needs to be passed. Or the x-${m}-config header should have a valid config with provider details in it.`}),{status:400,headers:{"content-type":"application/json"}});const t=aa.safeParse(e);if(!t.success&&t.error?.issues?.length)return new Response(JSON.stringify({status:"failure",message:"Invalid config passed",errors:t.error.issues.map((e=>`path: ${e.path}, message: ${e.message}`))}),{status:400,headers:{"content-type":"application/json"}});if(e.options)return new Response(JSON.stringify({status:"failure",message:"This version of config is not supported in this route. Please migrate to the latest version"}),{status:400,headers:{"content-type":"application/json"}})}catch(e){return new Response(JSON.stringify({status:"failure",message:"Invalid config passed. You need to pass a valid json"}),{status:400,headers:{"content-type":"application/json"}})}return t()};const ra=new t;ra.get("/",(e=>e.text("AI Gateway says hey!"))),ra.use("*",a()),ra.notFound((e=>e.json({message:"Not Found",ok:!1},404))),ra.onError(((e,t)=>e instanceof o?e.getResponse():(t.status(500),t.json({status:"failure",message:e.message})))),ra.post("/v1/complete",(async function(e){try{const t=await e.req.json(),a=Object.fromEntries(e.req.raw.headers);if(t.config?.targets&&t.config?.targets?.filter((e=>e.targets)).length>0)return new Response(JSON.stringify({status:"failure",message:"Please use the latest routes or SDK to use this version of config."}),{status:400,headers:{"content-type":"application/json"}});const o=Ut(t.config);if(!o)return new Response(JSON.stringify({status:"failure",message:"Could not find a provider option."}),{status:400,headers:{"content-type":"application/json"}});try{return await Ht(e,o,t.params,a,"complete")}catch(e){const t=JSON.parse(e.message);return new Response(t[t.length-1].errorObj,{status:t[t.length-1].status,headers:{"content-type":"application/json"}})}}catch(e){return console.log("complete error",e.message),new Response(JSON.stringify({status:"failure",message:"Something went wrong"}),{status:500,headers:{"content-type":"application/json"}})}})),ra.post("/v1/chatComplete",(async function(e){try{const t=await e.req.json(),a=Object.fromEntries(e.req.raw.headers);if(t.config?.targets&&t.config?.targets?.filter((e=>e.targets)).length>0)return new Response(JSON.stringify({status:"failure",message:"Please use the latest routes or SDK to use this version of config."}),{status:400,headers:{"content-type":"application/json"}});const o=Ut(t.config);if(!o)return new Response(JSON.stringify({status:"failure",message:"Could not find a provider option."}),{status:400,headers:{"content-type":"application/json"}});try{return await Ht(e,o,t.params,a,"chatComplete")}catch(e){const t=JSON.parse(e.message);return new Response(t[t.length-1].errorObj,{status:t[t.length-1].status,headers:{"content-type":"application/json"}})}}catch(e){return console.log("chatComplete error",e.message),new Response(JSON.stringify({status:"failure",message:"Something went wrong"}),{status:500,headers:{"content-type":"application/json"}})}})),ra.post("/v1/embed",(async function(e){try{const t=await e.req.json(),a=Object.fromEntries(e.req.raw.headers);if(t.config?.targets&&t.config?.targets?.filter((e=>e.targets)).length>0)return new Response(JSON.stringify({status:"failure",message:"Please use the latest routes or SDK to use this version of config."}),{status:400,headers:{"content-type":"application/json"}});let o=Ut(t.config);if(!o)return new Response(JSON.stringify({status:"failure",message:"Could not find a provider option."}),{status:400,headers:{"content-type":"application/json"}});try{return await Ht(e,o,t.params,a,"embed")}catch(e){console.error(`embed error: ${e.message}`);const t=JSON.parse(e.message);return new Response(t[t.length-1].errorObj,{status:t[t.length-1].status,headers:{"content-type":"application/json"}})}}catch(e){return new Response(JSON.stringify({status:"failure",message:"Something went wrong"}),{status:500,headers:{"content-type":"application/json"}})}})),ra.post("/v1/chat/completions",oa,ea),ra.post("/v1/completions",oa,ta),ra.post("/v1/embeddings",oa,(async function(e){try{let t=await e.req.json(),a=Object.fromEntries(e.req.raw.headers);const o=Ft(a);return await Wt(e,o,t,a,"embed","POST","config")}catch(e){return console.log("completion error",e.message),new Response(JSON.stringify({status:"failure",message:"Something went wrong"}),{status:500,headers:{"content-type":"application/json"}})}})),ra.post("/v1/images/generations",oa,(async function(e){try{let t=await e.req.json(),a=Object.fromEntries(e.req.raw.headers);const o=Ft(a);return await Wt(e,o,t,a,"imageGenerate","POST","config")}catch(e){return console.log("imageGenerate error",e.message),new Response(JSON.stringify({status:"failure",message:"Something went wrong"}),{status:500,headers:{"content-type":"application/json"}})}})),ra.post("/v1/prompts/*",oa,(e=>e.req.url.endsWith("/v1/chat/completions")?ea(e):e.req.url.endsWith("/v1/completions")?ta(e):(e.status(500),e.json({status:"failure",message:"prompt completions error: Something went wrong"})))),ra.post("/v1/proxy/*",Yt),ra.post("/v1/*",oa,Yt),ra.get("/v1/*",oa,Zt),ra.delete("/v1/*",oa,Zt);const na=process.argv.slice(2).find((e=>e.startsWith("--port="))),sa=na?parseInt(na.split("=")[1]):8787;e({fetch:ra.fetch,port:sa}),console.log(`Your AI Gateway is now running on http://localhost:${sa} 🚀`);
